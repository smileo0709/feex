<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>PredictX - Cloudflare Demo</title>
  <style>
    :root{
      --safeB: env(safe-area-inset-bottom, 0px);
      --fontScale: 1;
      --bg:#000;
      --card:#070a0f;
      --panel:#0b0f14;
      --border: rgba(255,255,255,.08);
      --text:#e7e9ea;
      --muted:#8b98a5;
      --accent:#1d9bf0;
      --danger:#f91880;
      --ok:#00ba7c;
      --radius:16px;
      --shadow: 0 0 0 1px rgba(255,255,255,.06);
      --font: ui-sans-serif, system-ui, -apple-system, "Segoe UI", Roboto, "Noto Sans TC", Helvetica, Arial, "Apple Color Emoji","Segoe UI Emoji";
    }
    [data-theme="light"]{
      --bg:#f7f7f8;
      --card:#ffffff;
      --panel:#ffffff;
      --border: rgba(0,0,0,.08);
      --text:#0b0f14;
      --muted:#536471;
      --shadow: 0 0 0 1px rgba(0,0,0,.06);
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0; background:var(--bg); color:var(--text);
      font-family:var(--font); line-height:1.35; overflow-x:hidden;
      font-size: calc(16px * var(--fontScale));
    }
    a{color:inherit;text-decoration:none}
    button,input,select,textarea{font-family:inherit}
    button{touch-action:manipulation}
    .muted{color:var(--muted)}
    .mono{font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono","Courier New", monospace;}
    .app{
      max-width:1320px; margin:0 auto;
      display:grid; grid-template-columns: 280px minmax(420px, 640px) 360px;
      gap:16px; padding: 12px 12px 24px;
    }
    .left{ position:sticky; top:12px; align-self:start; }
    .brand{display:flex; align-items:center; gap:10px; padding:10px 12px; border-radius:999px;}
    .xlogo{
      width:34px;height:34px;border-radius:10px; display:grid;place-items:center;
      background:linear-gradient(135deg, rgba(255,255,255,.08), rgba(255,255,255,.02));
      box-shadow:var(--shadow); font-weight:900;
    }
    [data-theme="light"] .xlogo{ background:linear-gradient(135deg, rgba(0,0,0,.08), rgba(0,0,0,.02)); }
    .nav{display:flex; flex-direction:column; gap:6px; margin-top:6px;}
    .nav a{display:flex; align-items:center; gap:12px; padding:10px 12px; border-radius:999px; transition:.12s ease;}
    .nav a:hover{background:rgba(255,255,255,.06)}
    [data-theme="light"] .nav a:hover{background:rgba(0,0,0,.04)}
    .nav a.active{background:rgba(29,155,240,.16); outline:1px solid rgba(29,155,240,.25);}
    .ico{ width:22px;height:22px; display:grid; place-items:center; font-size:18px; }
    .compose{
      margin-top:12px; padding:12px 14px; border:none; border-radius:999px;
      background:var(--accent); color:white; font-weight:800; cursor:pointer;
    }
    .mini{
      margin-top:12px; background:var(--panel); border:1px solid var(--border);
      border-radius:var(--radius); box-shadow:var(--shadow); padding:12px;
    }
    .mini .row{display:flex; justify-content:space-between; gap:10px; margin-top:8px; font-size:.85rem; color:var(--muted);}
    .pill{
      display:inline-flex; align-items:center; gap:6px; padding:6px 10px;
      background:rgba(255,255,255,.06); border:1px solid rgba(255,255,255,.10);
      border-radius:999px; font-size:.78rem; color:var(--muted);
    }
    [data-theme="light"] .pill{ background:rgba(0,0,0,.04); border-color:rgba(0,0,0,.08); }

    .center{min-height:80vh}
    .topbar{
      position:sticky; top:12px; z-index:10;
      background:rgba(0,0,0,.72); backdrop-filter: blur(10px);
      border:1px solid var(--border); border-radius:var(--radius);
      box-shadow:var(--shadow); padding:10px;
    }
    [data-theme="light"] .topbar{ background:rgba(255,255,255,.82); }
    .head{display:flex; align-items:center; justify-content:space-between; gap:10px; margin-bottom:10px;}
    .title{display:flex; align-items:center; gap:10px; font-weight:900; letter-spacing:.2px; font-size:1rem;}
    .burger{
      width:40px;height:40px;border-radius:999px;
      border:1px solid rgba(255,255,255,.12);
      background:rgba(255,255,255,.04);
      color:var(--text); cursor:pointer;
    }
    [data-theme="light"] .burger{ border-color:rgba(0,0,0,.10); background:rgba(0,0,0,.03); }

    .filters{display:flex; gap:8px; flex-wrap:wrap;}
    .chip{
      padding:8px 10px; border-radius:999px;
      border:1px solid rgba(255,255,255,.12);
      background:rgba(255,255,255,.03);
      color:var(--muted); cursor:pointer; font-size:.85rem; white-space:nowrap;
    }
    [data-theme="light"] .chip{ border-color:rgba(0,0,0,.10); background:rgba(0,0,0,.03); }
    .chip.active{background:rgba(29,155,240,.16); border-color:rgba(29,155,240,.28); color:var(--text);}

    .feed{ margin-top:12px; display:flex; flex-direction:column; gap:10px; }
    .card{
      background:var(--card); border:1px solid var(--border);
      border-radius:var(--radius); box-shadow:var(--shadow); padding:12px;
    }
    .meta{
      display:flex; align-items:center; justify-content:space-between; gap:10px;
      color:var(--muted); font-size:.78rem; margin-bottom:10px;
    }
    .meta .leftmeta{ display:flex; align-items:center; gap:8px; flex-wrap:wrap; }
    .tag{
      padding:3px 8px; border-radius:999px;
      border:1px solid rgba(255,255,255,.12);
      background:rgba(255,255,255,.05);
      color:var(--muted); font-size:.78rem;
    }
    [data-theme="light"] .tag{ border-color:rgba(0,0,0,.10); background:rgba(0,0,0,.03); }
    .qtitle{font-weight:900;font-size:1rem;margin:6px 0 10px;letter-spacing:.1px;}
    .clickTitle{
      cursor:pointer;
      text-decoration: underline;
      text-decoration-color: rgba(29,155,240,.35);
      text-underline-offset: 4px;
    }

    .coverSquare{ margin:10px 0 8px; display:flex; justify-content:center; }
    .coverBox{
      width: min(420px, 100%);
      aspect-ratio: 1 / 1;
      border-radius: 14px;
      overflow:hidden;
      border:1px solid rgba(255,255,255,.10);
      background: rgba(255,255,255,.03);
      box-shadow:var(--shadow);
    }
    [data-theme="light"] .coverBox{ border-color:rgba(0,0,0,.08); background:rgba(0,0,0,.02); }
    .coverBox img{ width:100%; height:100%; object-fit: cover; display:block; }

    .actions{
      display:flex; align-items:center; justify-content:space-between; gap:10px;
      flex-wrap:wrap; margin-top:12px;
    }
    .btn{
      border:1px solid rgba(255,255,255,.12);
      background:rgba(255,255,255,.03);
      color:var(--text); padding:8px 10px;
      border-radius:999px; cursor:pointer; font-size:.85rem;
    }
    [data-theme="light"] .btn{ border-color:rgba(0,0,0,.10); background:rgba(0,0,0,.03); }
    .btn.primary{background:rgba(29,155,240,.16);border-color:rgba(29,155,240,.35);}
    .btn.danger{background:rgba(249,24,128,.14);border-color:rgba(249,24,128,.30);}
    .inline{display:flex; gap:8px; align-items:center; flex-wrap:wrap; color:var(--muted); font-size:.78rem;}
    .iconBtn{
      display:inline-flex; align-items:center; gap:6px;
      padding:8px 10px; border-radius:999px;
      border:1px solid rgba(255,255,255,.12);
      background:rgba(255,255,255,.03);
      cursor:pointer; font-size:.85rem; color:var(--text);
    }
    [data-theme="light"] .iconBtn{ border-color:rgba(0,0,0,.10); background:rgba(0,0,0,.03); }
    .iconBtn.active{background: rgba(249,24,128,.14); border-color: rgba(249,24,128,.30);}

    .previewComments{ margin-top:10px; display:flex; flex-direction:column; gap:8px; }
    .pcomment{
      border:1px solid rgba(255,255,255,.10);
      background:rgba(255,255,255,.03);
      border-radius:12px; padding:10px;
    }
    [data-theme="light"] .pcomment{ border-color:rgba(0,0,0,.10); background:rgba(0,0,0,.02); }
    .pcommentHead{display:flex; justify-content:space-between; gap:10px; align-items:center; color:var(--muted); font-size:.78rem; margin-bottom:6px;}
    .pcommentBody{ font-size:.92rem; }
    .moreBtn{
      margin-top:6px; padding:0; background:transparent; border:none;
      color:var(--accent); cursor:pointer; font-size:.85rem; text-align:left;
    }

    .opts{display:flex; flex-direction:column; gap:8px; margin-top:10px;}
    .opt{
      border:1px solid rgba(255,255,255,.12);
      background:rgba(255,255,255,.03);
      border-radius:12px;
      padding:10px; cursor:pointer;
      display:flex; justify-content:space-between; align-items:center; gap:10px;
    }
    [data-theme="light"] .opt{ border-color:rgba(0,0,0,.10); background:rgba(0,0,0,.02); }
    .opt:hover{background:rgba(255,255,255,.05)}
    [data-theme="light"] .opt:hover{background:rgba(0,0,0,.04)}
    .opt .rightmuted{color:var(--muted);font-size:.78rem;min-width:76px;text-align:right;}
    .bar{
      height:8px;border-radius:999px;
      background:rgba(255,255,255,.06);
      border:1px solid rgba(255,255,255,.08);
      overflow:hidden;margin-top:8px;
    }
    [data-theme="light"] .bar{ background:rgba(0,0,0,.04); border-color:rgba(0,0,0,.06); }
    .bar>div{height:100%;width:0%;background:rgba(29,155,240,.9);}

    .page{display:none}
    .page.active{display:block}
    .formGrid{display:grid; grid-template-columns: 1fr 1fr; gap:10px;}
    .field{display:flex;flex-direction:column;gap:6px;}
    .field label{color:var(--muted);font-size:.78rem;}
    .field input,.field select,.field textarea{
      background:rgba(255,255,255,.03);
      border:1px solid rgba(255,255,255,.12);
      color:var(--text);
      border-radius:12px;
      padding:10px 10px;
      outline:none;
      font-size:1rem;
    }
    [data-theme="light"] .field input,[data-theme="light"] .field select,[data-theme="light"] .field textarea{
      border-color:rgba(0,0,0,.10); background:rgba(0,0,0,.02);
    }
    textarea{min-height:88px;resize:vertical}
    .note{color:var(--muted);font-size:.78rem;margin-top:8px;}
    .split{height:1px;background:rgba(255,255,255,.08);margin:12px 0;}
    [data-theme="light"] .split{background:rgba(0,0,0,.08);}
    .warn{
      color:#ffcc66; background:rgba(255,204,102,.08);
      border:1px solid rgba(255,204,102,.18);
      border-radius:12px; padding:10px; font-size:.9rem;
    }
    .ok{
      color:#9ff0d3; background:rgba(0,186,124,.10);
      border:1px solid rgba(0,186,124,.20);
      border-radius:12px; padding:10px; font-size:.9rem;
    }

    .right{ position:sticky; top:12px; align-self:start; }
    .search{
      display:flex;gap:8px;align-items:center;
      background:rgba(255,255,255,.04);
      border:1px solid rgba(255,255,255,.10);
      border-radius:999px;
      padding:10px 12px;
      box-shadow:var(--shadow);
    }
    [data-theme="light"] .search{ background:rgba(0,0,0,.03); border-color:rgba(0,0,0,.10); }
    .search input{flex:1;background:transparent;border:none;color:var(--text);outline:none;font-size:.95rem;}
    .panel{
      margin-top:12px; background:var(--panel);
      border:1px solid var(--border); border-radius:var(--radius);
      box-shadow:var(--shadow); overflow:hidden;
    }
    .panel h3{ margin:0; padding:12px 12px 10px; font-size:1rem; font-weight:900; border-bottom:1px solid rgba(255,255,255,.06); }
    [data-theme="light"] .panel h3{ border-bottom-color: rgba(0,0,0,.06); }
    .trend{ padding:12px; border-bottom:1px solid rgba(255,255,255,.06); cursor:pointer; }
    [data-theme="light"] .trend{ border-bottom-color: rgba(0,0,0,.06); }
    .trend:hover{background:rgba(255,255,255,.04)}
    [data-theme="light"] .trend:hover{background:rgba(0,0,0,.03)}
    .trend .t1{color:var(--muted);font-size:.78rem}
    .trend .t2{font-weight:900;margin-top:4px;font-size:.95rem}
    .trend .t3{color:var(--muted);font-size:.78rem;margin-top:6px}

    /* Drawer */
    .drawerBack{position:fixed;inset:0;background:rgba(0,0,0,.55);display:none;z-index:50;}
    .drawerBack.show{display:block}
    .drawer{
      position:fixed;top:0;left:0;height:100%;width:320px;
      background:var(--card);border-right:1px solid var(--border);
      box-shadow:0 20px 80px rgba(0,0,0,.35);
      transform:translateX(-100%);transition:transform .18s ease;
      z-index:51;padding:12px;
    }
    .drawer.open{transform:translateX(0)}
    .dhead{display:flex;align-items:center;justify-content:space-between;gap:10px;padding:6px 6px 10px;}
    .dtitle{font-weight:900}
    .closeBtn{
      width:36px;height:36px;border-radius:999px;
      border:1px solid rgba(255,255,255,.10);
      background:rgba(255,255,255,.04);
      color:var(--text);cursor:pointer;
    }
    [data-theme="light"] .closeBtn{ border-color:rgba(0,0,0,.10); background:rgba(0,0,0,.03); }
    .tagList{display:flex;flex-direction:column;gap:8px;padding:6px}
    .tagItem{
      padding:10px 12px;border-radius:12px;
      border:1px solid rgba(255,255,255,.12);
      background:rgba(255,255,255,.03);
      cursor:pointer;display:flex;justify-content:space-between;align-items:center;
    }
    [data-theme="light"] .tagItem{ border-color:rgba(0,0,0,.10); background:rgba(0,0,0,.02); }
    .tagItem span{color:var(--muted);font-size:.78rem}

    @media (max-width: 980px){
      .app{grid-template-columns: 88px 1fr 320px;}
      .label-hide{display:none;}
    }
    @media (max-width: 900px){
      .app{grid-template-columns:1fr;gap:12px;padding:10px 10px calc(86px + var(--safeB));}
      .right{display:none !important;}
      .center{order:1;}
      .left{
        position:fixed !important; left:0; right:0; bottom:0; top:auto !important;
        z-index:60; padding: 8px 10px calc(10px + var(--safeB));
        background: rgba(0,0,0,.88); backdrop-filter: blur(12px);
        border-top: 1px solid rgba(255,255,255,.10);
      }
      [data-theme="light"] .left{ background: rgba(255,255,255,.86); border-top-color: rgba(0,0,0,.10); }
      .brand,.compose,.mini{display:none !important;}
      .nav{flex-direction:row !important;justify-content:space-around;gap:8px;margin-top:0 !important;}
      .nav a{flex:1;justify-content:center;padding:12px 10px;border-radius:16px;}
      .ico{font-size:20px;width:24px;height:24px}
      .topbar{position:relative !important; top:auto !important; border-radius:14px;}
      .mobileSearch{display:flex !important;}
      .filters{flex-wrap:nowrap;overflow:auto;-webkit-overflow-scrolling: touch;scrollbar-width:none;}
      .filters::-webkit-scrollbar{display:none;}
      .chip{flex:0 0 auto;}
      .drawer{width:84vw;max-width:360px;}
    }

    .fab{
      position:fixed; right:16px;
      bottom: calc(86px + var(--safeB) + 10px);
      width:54px;height:54px;border-radius:999px;
      border:1px solid rgba(255,255,255,.12);
      background: rgba(29,155,240,.95);
      color:#fff;font-size:28px;font-weight:900;
      cursor:pointer; box-shadow: 0 16px 50px rgba(0,0,0,.35); z-index:70;
    }
    @media (min-width: 901px){ .fab{display:none;} }

    .modalBack{position:fixed; inset:0;background:rgba(0,0,0,.55);display:none;z-index:90;}
    .modalBack.show{display:block;}
    .modal{
      position:fixed;left:50%;top:50%;
      transform:translate(-50%,-50%);
      width:min(720px, 92vw); max-height:82vh; overflow:auto;
      background:var(--card); border:1px solid var(--border);
      border-radius:18px; box-shadow:0 30px 120px rgba(0,0,0,.45);
      padding:12px; z-index:91; display:none;
    }
    .modal.show{display:block;}
    .modalHead{display:flex; justify-content:space-between; align-items:center; gap:10px; margin-bottom:10px;}
    .modalTitle{font-weight:900}
    .modal textarea{
      width:100%; min-height:220px;
      background:rgba(255,255,255,.03);
      border:1px solid rgba(255,255,255,.12);
      color:var(--text);
      border-radius:12px; padding:10px; outline:none; font-size:.9rem;
    }
    [data-theme="light"] .modal textarea{ border-color:rgba(0,0,0,.10); background:rgba(0,0,0,.02); }
  </style>
</head>

<body>
  <div class="drawerBack" id="drawerBack"></div>
  <aside class="drawer" id="drawer" aria-hidden="true">
    <div class="dhead">
      <div class="dtitle">åˆ†é¡ TAG</div>
      <button class="closeBtn" id="closeDrawer" aria-label="é—œé–‰">âœ•</button>
    </div>
    <div class="tagList" id="tagList"></div>
    <div class="note">é»åˆ†é¡å¾Œæœƒå›åˆ°ã€Œé æ¸¬ã€é ä¸¦å¥—ç”¨ç¯©é¸ã€‚</div>
  </aside>

  <div class="modalBack" id="modalBack"></div>
  <div class="modal" id="modal">
    <div class="modalHead">
      <div class="modalTitle" id="modalTitle">ç™»å…¥</div>
      <button class="closeBtn" id="closeModal" aria-label="é—œé–‰">âœ•</button>
    </div>
    <div class="formGrid">
      <div class="field" style="grid-column:1/-1">
        <label>Email</label>
        <input id="authEmail" placeholder="you@example.com" />
      </div>
      <div class="field" style="grid-column:1/-1">
        <label>Passwordï¼ˆ>=6ï¼‰</label>
        <input id="authPass" type="password" placeholder="******" />
      </div>
    </div>
    <div class="actions" style="margin-top:10px">
      <div class="inline"><span class="pill">Cloudflare D1 å¸³è™Ÿ</span></div>
      <div style="display:flex; gap:8px; flex-wrap:wrap;">
        <button class="btn" id="btnRegister">è¨»å†Š</button>
        <button class="btn primary" id="btnLogin">ç™»å…¥</button>
      </div>
    </div>
    <div class="note" id="authNote">ç™»å…¥å¾Œæ‰å¯çœ‹å»£å‘Šã€æŠ•ç¥¨ã€ç•™è¨€ã€å»ºç«‹äº‹ä»¶ã€‚</div>
  </div>

  <div class="app">
    <aside class="left">
      <div class="brand">
        <div class="xlogo">PX</div>
        <div class="label-hide">
          <div style="font-weight:900;letter-spacing:.2px">PredictX</div>
          <div class="muted" style="font-size:.78rem">Cloudflare + D1</div>
        </div>
      </div>

      <nav class="nav" id="nav">
        <a href="#" data-page="predict" class="active"><span class="ico">ğŸ </span><span class="label-hide">æœªä¾†äº‹ä»¶é æ¸¬</span></a>
        <a href="#" data-page="publish"><span class="ico">â•</span><span class="label-hide">æœªä¾†äº‹ä»¶ç™¼å¸ƒ</span></a>
        <a href="#" data-page="profile"><span class="ico">ğŸ‘¤</span><span class="label-hide">å€‹äººæª”æ¡ˆ</span></a>
        <a href="#" data-page="rules"><span class="ico">ğŸ“œ</span><span class="label-hide">è¦å‰‡&è¨­å®š</span></a>
      </nav>

      <button class="compose" id="watchAdTop">çœ‹å»£å‘Šæ‹¿é‡‘å¹£ï¼ˆ+100 GCï¼‰</button>

      <div class="mini" id="miniProfile">
        <div style="display:flex; align-items:center; justify-content:space-between; gap:10px;">
          <div style="font-weight:900">ä½ çš„ç‹€æ…‹</div>
          <span class="pill" id="miniTier">Tier ?</span>
        </div>
        <div class="row"><span>ç™»å…¥</span><span id="miniAuth">æœªç™»å…¥</span></div>
        <div class="row"><span>æš±ç¨±</span><span id="miniNick">-</span></div>
        <div class="row"><span>GC</span><span id="miniGC">-</span></div>
        <div class="row"><span>å‹ç‡</span><span id="miniWR">-</span></div>
        <div class="row"><span>ç­‰ç´š</span><span id="miniLvl">-</span></div>
      </div>
    </aside>

    <main class="center">
      <div class="topbar">
        <div class="head">
          <div class="title">
            <button class="burger" id="openDrawer" aria-label="é–‹å•Ÿåˆ†é¡">â˜°</button>
            <span id="pageTitle">æœªä¾†äº‹ä»¶é æ¸¬</span>
            <span class="pill" id="activeTagPill">TAGï¼šå…¨éƒ¨</span>
          </div>
          <div class="inline">
            <span class="pill" id="authPill">æœªç™»å…¥</span>
            <button class="btn" id="btnOpenAuth">ç™»å…¥/è¨»å†Š</button>
          </div>
        </div>

        <div class="search mobileSearch" id="mobileSearch" style="display:none; margin-bottom:10px;">
          <span style="color:var(--muted)">ğŸ”</span>
          <input id="searchInputMobile" placeholder="æœå°‹é¡Œç›®/é—œéµå­—â€¦" />
        </div>

        <div class="filters" id="hotFilters">
          <button class="chip active" data-hot="day">ç•¶æ—¥ç†±é–€</button>
          <button class="chip" data-hot="week">æœ¬é€±ç†±é–€</button>
          <button class="chip" data-hot="month">æœ¬æœˆç†±é–€</button>
          <button class="chip" data-hot="all">ç¸½ç†±é–€</button>
        </div>
      </div>

      <section class="page active" id="page-predict">
        <div class="feed" id="feed"></div>
      </section>

      <section class="page" id="page-detail">
        <div class="card" id="detailCard"></div>
      </section>

      <section class="page" id="page-publish">
        <div class="card">
          <div class="meta">
            <div class="leftmeta">
              <span class="tag">ç™¼å¸ƒé æ¸¬</span>
              <span class="tag">è²»ç”¨ï¼š1000 GC</span>
              <span class="tag">é¸é …ï¼š2ï½12</span>
              <span class="tag">å°é¢ï¼šæ­£æ–¹å½¢ç½®ä¸­</span>
            </div>
            <div class="muted">å¾Œç«¯å¯ä¿¡æ‰£æ¬¾</div>
          </div>

          <div class="formGrid">
            <div class="field" style="grid-column:1/-1">
              <label>é¡Œç›®</label>
              <input id="pubTitle" placeholder="ä¾‹ï¼š2026 ä¸–è¶³å† è»æœƒæ˜¯èª°ï¼Ÿ" maxlength="120" />
            </div>

            <div class="field">
              <label>åˆ†é¡ TAG</label>
              <select id="pubTag"></select>
            </div>

            <div class="field">
              <label>çµç®—æ—¥æœŸ</label>
              <input id="pubSettle" type="date" />
            </div>

            <div class="field" style="grid-column:1/-1">
              <label>å°é¢åœ–ç‰‡ç¶²å€ï¼ˆå¯è²¼ç¸®ç¶²å€ï¼Œä½†æœ€å¥½æ˜¯ç›´æ¥åœ–ç‰‡é€£çµï¼‰</label>
              <input id="pubCover" placeholder="https://...jpg/png/webp" />
            </div>

            <div class="field" style="grid-column:1/-1">
              <label>é¸é …ï¼ˆæ¯è¡Œä¸€å€‹ï¼‰</label>
              <textarea id="pubOptions" placeholder="ä¾‹å¦‚ï¼š&#10;é˜¿æ ¹å»·&#10;æ³•åœ‹&#10;å·´è¥¿"></textarea>
            </div>
          </div>

          <div class="actions">
            <div class="inline">
              <span class="pill">æç¤ºï¼šå…ˆçœ‹å»£å‘Šæ¹Š GC</span>
            </div>
            <div style="display:flex; gap:8px; flex-wrap:wrap;">
              <button class="btn primary" id="createPrediction">å»ºç«‹é æ¸¬ï¼ˆæ‰£ 1000 GCï¼‰</button>
            </div>
          </div>
          <div class="note" id="pubNote"></div>
        </div>
      </section>

      <section class="page" id="page-profile">
        <div class="card">
          <div class="meta">
            <div class="leftmeta">
              <span class="tag">å€‹äººæª”æ¡ˆ</span>
              <span class="tag">å¾Œç«¯å„²å­˜</span>
            </div>
            <div class="muted">å­—é«”å¤§å°åœ¨ã€Œè¦å‰‡&è¨­å®šã€èª¿æ•´ï¼ˆæœ¬æ©Ÿï¼‰</div>
          </div>

          <div class="formGrid">
            <div class="field">
              <label>æš±ç¨±</label>
              <input id="pNick" maxlength="20" />
            </div>
            <div class="field">
              <label>æœƒå“¡ç­‰ç´šï¼ˆTierï¼‰</label>
              <select id="pTier">
                <option value="1">1 æ–°æ‰‹</option>
                <option value="2">2 å¯è©•è«–</option>
                <option value="3">3 å¯è©•é‘‘</option>
                <option value="4">4 å¯å»ºç«‹äº‹ä»¶</option>
                <option value="5">5 å¯åˆªç•™è¨€</option>
                <option value="6">6 è‡ªæ²»è£æ±º</option>
                <option value="7">7 Manager</option>
                <option value="8">8 å¯åˆ†æ½¤ï¼ˆé«˜é¢¨éšªï¼‰</option>
                <option value="9">9 BM</option>
                <option value="10">10 Director å€™é¸</option>
              </select>
            </div>

            <div class="field" style="grid-column:1/-1">
              <label>å€‹äººç°½å</label>
              <textarea id="pBio" maxlength="140"></textarea>
            </div>

            <div class="field">
              <label>ç­‰ç´šï¼ˆLevelï¼‰</label>
              <input id="pLevel" type="number" min="1" step="1" />
            </div>

            <div class="field">
              <label>é æ¸¬å‹ç‡ï¼ˆ%ï¼‰</label>
              <input id="pWR" type="number" min="0" max="100" step="1" />
            </div>
          </div>

          <div class="actions">
            <div class="inline">
              <span class="pill">GC ç”±å¾Œç«¯æ§åˆ¶ï¼ˆçœ‹å»£å‘Š/æ‰£è²»ï¼‰</span>
            </div>
            <div style="display:flex; gap:8px; flex-wrap:wrap;">
              <button class="btn" id="watchAd">çœ‹å»£å‘Šï¼ˆ+100 GCï¼‰</button>
              <button class="btn primary" id="saveProfile">å„²å­˜</button>
              <button class="btn danger" id="logout">ç™»å‡º</button>
            </div>
          </div>
          <div class="note" id="profileNote"></div>
        </div>
      </section>

      <section class="page" id="page-rules">
        <div class="card">
          <div class="meta">
            <div class="leftmeta">
              <span class="tag">è¦å‰‡</span>
              <span class="tag">è¨­å®š</span>
            </div>
            <div class="muted">çµ¦ä½¿ç”¨è€…çœ‹çš„èªªæ˜</div>
          </div>

          <div class="ok">
            <b>å¹³å°ç”¨é€”</b><br/>
            æœ¬å¹³å°æä¾›ã€Œæœªä¾†äº‹ä»¶é æ¸¬ã€äº’å‹•èˆ‡ç¤¾ç¾¤è¨è«–ï¼Œå±¬æ–¼å¨›æ¨‚èˆ‡è³‡è¨Šäº¤æµç”¨é€”ã€‚GC ç‚ºå¹³å°å…§éƒ¨ä½¿ç”¨é»æ•¸ï¼Œç”¨æ–¼å¹³å°åŠŸèƒ½èˆ‡äº’å‹•ã€‚
          </div>

          <div class="split"></div>

          <div class="warn">
            <b>ä½¿ç”¨é¢¨éšªèˆ‡é‡è¦æé†’ï¼ˆçµ¦ä½¿ç”¨è€…ï¼‰</b><br/>
            1) å¹³å°å…§å®¹ç”±ä½¿ç”¨è€…ç™¼å¸ƒï¼Œè³‡æ–™ä¾†æºå¯èƒ½ä¸å®Œæ•´æˆ–æœ‰èª¤ï¼Œè«‹è‡ªè¡Œåˆ¤æ–·ã€‚<br/>
            2) é æ¸¬çµæœä¸ä¿è­‰æ­£ç¢ºï¼Œä¸æ§‹æˆä»»ä½•å»ºè­°æˆ–ä¿è­‰ã€‚<br/>
            3) GC ç‚ºå¹³å°å…§éƒ¨é»æ•¸ï¼Œä¸å¯å…Œæ›ç¾é‡‘æˆ–ä»£å¹£ã€‚<br/>
            4) ç†±é–€/æŒ‰è®šå¯èƒ½è¢«æ“æ§ï¼Œä¸ä»£è¡¨å®¢è§€äº‹å¯¦ã€‚<br/>
            5) å¤–éƒ¨é€£çµèˆ‡å»£å‘Šè·³è½‰è«‹æ³¨æ„è³‡å®‰èˆ‡å€‹è³‡é¢¨éšªã€‚
          </div>

          <div class="split"></div>

          <div class="ok"><b>è¨­å®šï¼ˆæœ¬æ©Ÿï¼‰</b><br/>ä»¥ä¸‹è¨­å®šå­˜æ–¼ localStorageã€‚</div>

          <div class="split"></div>

          <div class="formGrid">
            <div class="field">
              <label>å­—é«”å¤§å°ï¼ˆå…¨ç«™ï¼‰</label>
              <select id="sFontSize">
                <option value="0.92">å°</option>
                <option value="1.00">ä¸­ï¼ˆé è¨­ï¼‰</option>
                <option value="1.08">å¤§</option>
                <option value="1.18">ç‰¹å¤§</option>
              </select>
            </div>

            <div class="field">
              <label>ä¸»é¡Œ</label>
              <select id="sTheme">
                <option value="dark">é—œç‡ˆï¼ˆæ·±è‰²ï¼‰</option>
                <option value="light">é–‹ç‡ˆï¼ˆæ·ºè‰²ï¼‰</option>
              </select>
            </div>
          </div>

          <div class="actions">
            <div class="inline"><span class="pill">å·¥å…·æŒ‰éˆ•</span></div>
            <div style="display:flex; gap:8px; flex-wrap:wrap;">
              <button class="btn" id="btnToggleTheme">ğŸŒ— é–‹ç‡ˆ/é—œç‡ˆ</button>
              <button class="btn danger" id="btnClearLocal">ğŸ§¹ æ¸…é™¤æœ¬æ©Ÿè¨­å®š</button>
            </div>
          </div>
        </div>
      </section>
    </main>

    <aside class="right">
      <div class="search">
        <span style="color:var(--muted)">ğŸ”</span>
        <input id="searchInput" placeholder="æœå°‹é¡Œç›®/é—œéµå­—â€¦" />
      </div>

      <div class="panel">
        <h3>ç†±é–€ï¼ˆä¾ç›®å‰æ’åºï¼‰</h3>
        <div id="trends"></div>
      </div>

      <div class="panel">
        <h3>æç¤º</h3>
        <div class="trend" style="cursor:default">
          <div class="t2">å…ˆç™»å…¥</div>
          <div class="t3">ç™»å…¥å¾Œæ‰å¯çœ‹å»£å‘Šã€æŠ•ç¥¨ã€ç•™è¨€ã€å»ºç«‹é æ¸¬ã€‚</div>
        </div>
      </div>
    </aside>
  </div>

  <button class="fab" id="fabPublish" title="ç™¼å¸ƒé æ¸¬" aria-label="ç™¼å¸ƒé æ¸¬">ï¼‹</button>

<script>
/** =========================
 *  CONFIG
 * ========================= */
// âœ… æœ¬æ©Ÿæ¸¬è©¦ï¼šWorker ç«¯ wrangler dev é€šå¸¸æ˜¯é€™å€‹
// ä¸Šç·šå¾Œæ›æˆä½ çš„ worker ç¶²å€ï¼Œä¾‹å¦‚ https://predictx-api.yourname.workers.dev
const API_BASE = "http://127.0.0.1:8787";

const TAGS = [
  {key:"all", name:"å…¨éƒ¨"},
  {key:"sports", name:"é‹å‹•"},
  {key:"current", name:"æ™‚å‹¢"},
  {key:"politics", name:"æ”¿æ²»"},
  {key:"tech", name:"ç§‘æŠ€"},
  {key:"ent", name:"å¨›æ¨‚"},
  {key:"finance", name:"è²¡ç¶“"},
];

const LS = {
  ui: "px_cf_ui_v1",
  theme: "px_cf_theme_v1",
  font: "px_cf_font_v1",
  token: "px_cf_token_v1",
};

let token = localStorage.getItem(LS.token) || "";

/** =========================
 *  UI STATE
 * ========================= */
function loadJSON(key, fallback){ try{ const v=localStorage.getItem(key); return v?JSON.parse(v):fallback; }catch{return fallback;} }
function saveJSON(key, value){ localStorage.setItem(key, JSON.stringify(value)); }

let ui = loadJSON(LS.ui, { page:"predict", hot:"day", tag:"all", q:"", detailId:null, previewExpand:{} });

/** =========================
 *  Helpers
 * ========================= */
function esc(s){ return String(s).replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#039;'}[m])); }
function truncateText(s, n){
  const t = String(s ?? "");
  if(t.length <= n) return {text: t, truncated:false};
  return {text: t.slice(0, n) + "â€¦", truncated:true};
}
function fmtDate(ms){
  try { return new Date(ms).toLocaleString("zh-Hant", {month:"2-digit", day:"2-digit", hour:"2-digit", minute:"2-digit"}); }
  catch { return ""; }
}
function hotLabel(h){ return ({day:"ç•¶æ—¥ç†±é–€", week:"æœ¬é€±ç†±é–€", month:"æœ¬æœˆç†±é–€", all:"ç¸½ç†±é–€"})[h] || "ç†±é–€"; }

async function api(path, opts={}){
  const headers = Object.assign({ "Content-Type":"application/json" }, opts.headers || {});
  if(token) headers["Authorization"] = "Bearer " + token;
  const res = await fetch(API_BASE + path, { ...opts, headers });
  const data = await res.json().catch(()=>({ ok:false, error:"Bad JSON" }));
  if(!res.ok && data?.error) throw new Error(data.error);
  return data;
}

/** =========================
 *  DOM
 * ========================= */
const els = {
  nav: document.getElementById("nav"),
  pageTitle: document.getElementById("pageTitle"),
  activeTagPill: document.getElementById("activeTagPill"),
  feed: document.getElementById("feed"),
  trends: document.getElementById("trends"),
  detailCard: document.getElementById("detailCard"),
  hotFilters: document.getElementById("hotFilters"),

  drawerBack: document.getElementById("drawerBack"),
  drawer: document.getElementById("drawer"),
  openDrawer: document.getElementById("openDrawer"),
  closeDrawer: document.getElementById("closeDrawer"),
  tagList: document.getElementById("tagList"),

  searchInput: document.getElementById("searchInput"),
  searchInputMobile: document.getElementById("searchInputMobile"),

  fabPublish: document.getElementById("fabPublish"),

  // mini
  miniAuth: document.getElementById("miniAuth"),
  miniNick: document.getElementById("miniNick"),
  miniGC: document.getElementById("miniGC"),
  miniWR: document.getElementById("miniWR"),
  miniLvl: document.getElementById("miniLvl"),
  miniTier: document.getElementById("miniTier"),

  // auth
  authPill: document.getElementById("authPill"),
  btnOpenAuth: document.getElementById("btnOpenAuth"),
  modalBack: document.getElementById("modalBack"),
  modal: document.getElementById("modal"),
  closeModal: document.getElementById("closeModal"),
  authEmail: document.getElementById("authEmail"),
  authPass: document.getElementById("authPass"),
  btnRegister: document.getElementById("btnRegister"),
  btnLogin: document.getElementById("btnLogin"),
  authNote: document.getElementById("authNote"),

  // publish
  pubTitle: document.getElementById("pubTitle"),
  pubTag: document.getElementById("pubTag"),
  pubSettle: document.getElementById("pubSettle"),
  pubCover: document.getElementById("pubCover"),
  pubOptions: document.getElementById("pubOptions"),
  createPrediction: document.getElementById("createPrediction"),
  pubNote: document.getElementById("pubNote"),

  // profile
  pNick: document.getElementById("pNick"),
  pTier: document.getElementById("pTier"),
  pBio: document.getElementById("pBio"),
  pLevel: document.getElementById("pLevel"),
  pWR: document.getElementById("pWR"),
  saveProfile: document.getElementById("saveProfile"),
  watchAd: document.getElementById("watchAd"),
  watchAdTop: document.getElementById("watchAdTop"),
  logout: document.getElementById("logout"),
  profileNote: document.getElementById("profileNote"),

  // settings
  sFontSize: document.getElementById("sFontSize"),
  sTheme: document.getElementById("sTheme"),
  btnToggleTheme: document.getElementById("btnToggleTheme"),
  btnClearLocal: document.getElementById("btnClearLocal"),
};

let me = null;
let cacheFeed = [];
let cacheDetail = null;

/** =========================
 *  Drawer
 * ========================= */
function openDrawer(){
  els.drawerBack.classList.add("show");
  els.drawer.classList.add("open");
  document.body.style.overflow = "hidden";
}
function closeDrawer(){
  els.drawerBack.classList.remove("show");
  els.drawer.classList.remove("open");
  document.body.style.overflow = "";
}
els.openDrawer.addEventListener("click", openDrawer);
els.closeDrawer.addEventListener("click", closeDrawer);
els.drawerBack.addEventListener("click", closeDrawer);

function renderTagList(){
  els.tagList.innerHTML = "";
  const add = (key, name, hint) => {
    const div = document.createElement("div");
    div.className = "tagItem";
    div.innerHTML = `<div>${esc(name)}</div><span>${esc(hint)}</span>`;
    div.addEventListener("click", ()=>{
      ui.tag = key;
      ui.page = "predict";
      ui.detailId = null;
      saveJSON(LS.ui, ui);
      closeDrawer();
      setPage("predict");
    });
    els.tagList.appendChild(div);
  };
  add("all","å…¨éƒ¨","æ¸…é™¤ç¯©é¸");
  TAGS.filter(t=>t.key!=="all").forEach(t=>add(t.key, t.name, "é»é¸å¥—ç”¨"));
}

/** =========================
 *  Auth modal
 * ========================= */
function openModal(){
  els.modalBack.classList.add("show");
  els.modal.classList.add("show");
  document.body.style.overflow = "hidden";
}
function closeModal(){
  els.modalBack.classList.remove("show");
  els.modal.classList.remove("show");
  document.body.style.overflow = "";
}
els.btnOpenAuth.addEventListener("click", openModal);
els.closeModal.addEventListener("click", closeModal);
els.modalBack.addEventListener("click", closeModal);

els.btnRegister.addEventListener("click", async ()=>{
  try{
    const email = els.authEmail.value.trim();
    const password = els.authPass.value;
    const r = await api("/api/register", { method:"POST", body: JSON.stringify({ email, password }) });
    if(r.ok) els.authNote.textContent = "è¨»å†ŠæˆåŠŸï¼Œè«‹æŒ‰ç™»å…¥ã€‚";
  }catch(e){ els.authNote.textContent = "è¨»å†Šå¤±æ•—ï¼š" + e.message; }
});
els.btnLogin.addEventListener("click", async ()=>{
  try{
    const email = els.authEmail.value.trim();
    const password = els.authPass.value;
    const r = await api("/api/login", { method:"POST", body: JSON.stringify({ email, password }) });
    token = r.token;
    localStorage.setItem(LS.token, token);
    await loadMe();
    closeModal();
    renderAll();
  }catch(e){ els.authNote.textContent = "ç™»å…¥å¤±æ•—ï¼š" + e.message; }
});
els.logout.addEventListener("click", ()=>{
  token = "";
  localStorage.removeItem(LS.token);
  me = null;
  cacheDetail = null;
  renderAll();
});

async function loadMe(){
  if(!token){ me=null; return; }
  const r = await api("/api/me");
  me = r.user;
}

/** =========================
 *  Routing
 * ========================= */
function setPage(page){
  ui.page = page;
  saveJSON(LS.ui, ui);

  document.querySelectorAll(".nav a").forEach(a=>{
    a.classList.toggle("active", a.dataset.page === page);
  });

  document.querySelectorAll(".page").forEach(p=>p.classList.remove("active"));
  const sec = document.getElementById("page-" + page);
  if(sec) sec.classList.add("active");

  const titleMap = {
    predict:"æœªä¾†äº‹ä»¶é æ¸¬",
    detail:"é¡Œç›®è©³æƒ…",
    publish:"æœªä¾†äº‹ä»¶ç™¼å¸ƒ",
    profile:"å€‹äººæª”æ¡ˆ",
    rules:"è¦å‰‡&è¨­å®š",
  };
  els.pageTitle.textContent = titleMap[page] || "PredictX";
  els.hotFilters.style.display = (page === "predict") ? "flex" : "none";
  els.fabPublish.style.display = (page === "publish") ? "none" : "";

  renderAll();
}

els.nav.addEventListener("click", (e)=>{
  const a = e.target.closest("a[data-page]");
  if(!a) return;
  e.preventDefault();
  ui.detailId = null;
  setPage(a.dataset.page);
});
els.fabPublish.addEventListener("click", ()=> { ui.detailId=null; setPage("publish"); });

/** =========================
 *  Filters + Search
 * ========================= */
els.hotFilters.addEventListener("click", (e)=>{
  const b = e.target.closest(".chip[data-hot]");
  if(!b) return;
  ui.hot = b.dataset.hot;
  saveJSON(LS.ui, ui);
  loadFeed().then(renderAll);
});
function bindSearchInput(inputEl){
  if(!inputEl) return;
  inputEl.value = ui.q || "";
  inputEl.addEventListener("input", ()=>{
    ui.q = (inputEl.value || "").trim();
    if(inputEl === els.searchInput && els.searchInputMobile) els.searchInputMobile.value = ui.q;
    if(inputEl === els.searchInputMobile && els.searchInput) els.searchInput.value = ui.q;
    saveJSON(LS.ui, ui);
    loadFeed().then(renderAll);
  });
}
bindSearchInput(els.searchInput);
bindSearchInput(els.searchInputMobile);

/** =========================
 *  Settings (local)
 * ========================= */
function applyTheme(theme){ document.documentElement.setAttribute("data-theme", theme === "light" ? "light" : "dark"); }
function applyFont(scale){
  const v = Number(scale);
  const safe = Number.isFinite(v) ? Math.max(0.85, Math.min(1.25, v)) : 1;
  document.documentElement.style.setProperty("--fontScale", String(safe));
}
function syncLocalSettingsUI(){
  const theme = localStorage.getItem(LS.theme) || "dark";
  const font = localStorage.getItem(LS.font) || "1.00";
  els.sTheme.value = theme;
  els.sFontSize.value = font;
  applyTheme(theme);
  applyFont(font);
}
els.sTheme.addEventListener("change", ()=>{
  localStorage.setItem(LS.theme, els.sTheme.value);
  syncLocalSettingsUI();
});
els.sFontSize.addEventListener("change", ()=>{
  localStorage.setItem(LS.font, els.sFontSize.value);
  syncLocalSettingsUI();
});
els.btnToggleTheme.addEventListener("click", ()=>{
  const cur = localStorage.getItem(LS.theme) || "dark";
  localStorage.setItem(LS.theme, cur === "light" ? "dark" : "light");
  syncLocalSettingsUI();
});
els.btnClearLocal.addEventListener("click", ()=>{
  localStorage.removeItem(LS.theme);
  localStorage.removeItem(LS.font);
  syncLocalSettingsUI();
});

/** =========================
 *  Feed / Detail loading
 * ========================= */
async function loadFeed(){
  const qs = new URLSearchParams({ tag: ui.tag, hot: ui.hot, q: ui.q || "" });
  const r = await api("/api/predictions?" + qs.toString(), { method:"GET" });
  cacheFeed = r.predictions || [];
}
async function loadDetail(predId){
  const r = await api("/api/predictions/" + encodeURIComponent(predId), { method:"GET" });
  cacheDetail = r.prediction;
}
function openDetail(predId){
  ui.detailId = predId;
  ui.page = "detail";
  saveJSON(LS.ui, ui);
  setPage("detail");
  window.scrollTo({top:0, behavior:"smooth"});
}

/** =========================
 *  Actions
 * ========================= */
async function watchAd(){
  if(!token) return openModal();
  try{
    const r = await api("/api/claim-ad", { method:"POST" });
    await loadMe();
    alert("å·²ç²å¾— 100 GC");
    renderAll();
  }catch(e){
    // cooldown conflict returns message in worker, show friendly
    alert("æš«æ™‚ä¸èƒ½çœ‹å»£å‘Šï¼š" + e.message);
  }
}
els.watchAd.addEventListener("click", watchAd);
els.watchAdTop.addEventListener("click", watchAd);

function renderPubTag(){
  els.pubTag.innerHTML = TAGS.filter(t=>t.key!=="all").map(t=>`<option value="${t.key}">${esc(t.name)}</option>`).join("");
}
els.createPrediction.addEventListener("click", async ()=>{
  if(!token) return openModal();
  try{
    const title = (els.pubTitle.value || "").trim();
    const tag = els.pubTag.value;
    const settleDate = els.pubSettle.value;
    const coverUrl = (els.pubCover.value || "").trim();
    const options = (els.pubOptions.value || "").split("\n").map(s=>s.trim()).filter(Boolean);

    const r = await api("/api/predictions", {
      method:"POST",
      body: JSON.stringify({ title, tag, settleDate, coverUrl, options })
    });

    els.pubNote.textContent = "å·²å»ºç«‹ï¼ˆæ‰£ 1000 GCï¼‰ã€‚";
    els.pubTitle.value = ""; els.pubSettle.value = ""; els.pubCover.value = ""; els.pubOptions.value = "";
    await loadMe();
    await loadFeed();
    ui.page = "predict"; ui.tag = tag;
    setPage("predict");
  }catch(e){
    els.pubNote.textContent = "å»ºç«‹å¤±æ•—ï¼š" + e.message;
  }
});

els.saveProfile.addEventListener("click", async ()=>{
  if(!token) return openModal();
  try{
    const body = {
      nick: els.pNick.value,
      bio: els.pBio.value,
      tier: Number(els.pTier.value),
      level: Number(els.pLevel.value),
      winRate: Number(els.pWR.value),
    };
    const r = await api("/api/me", { method:"PATCH", body: JSON.stringify(body) });
    me = r.user;
    els.profileNote.textContent = "å·²å„²å­˜";
    renderAll();
  }catch(e){
    els.profileNote.textContent = "å„²å­˜å¤±æ•—ï¼š" + e.message;
  }
});

/** =========================
 *  Render
 * ========================= */
function renderMini(){
  if(!me){
    els.miniAuth.textContent = "æœªç™»å…¥";
    els.miniNick.textContent = "-";
    els.miniGC.textContent = "-";
    els.miniWR.textContent = "-";
    els.miniLvl.textContent = "-";
    els.miniTier.textContent = "Tier ?";
    els.authPill.textContent = "æœªç™»å…¥";
  }else{
    els.miniAuth.textContent = me.email;
    els.miniNick.textContent = me.nick;
    els.miniGC.textContent = String(me.gc);
    els.miniWR.textContent = me.winRate + "%";
    els.miniLvl.textContent = String(me.level);
    els.miniTier.textContent = "Tier " + me.tier;
    els.authPill.textContent = me.nick + " Â· GC " + me.gc;
  }
}
function renderActiveTag(){
  const tagName = TAGS.find(t=>t.key===ui.tag)?.name || "å…¨éƒ¨";
  els.activeTagPill.textContent = "TAGï¼š" + tagName;
}
function renderHotFilterState(){
  document.querySelectorAll(".chip[data-hot]").forEach(c=>{
    c.classList.toggle("active", c.dataset.hot === ui.hot);
  });
}

function renderFeed(){
  els.feed.innerHTML = "";
  if(cacheFeed.length === 0){
    const empty = document.createElement("div");
    empty.className = "card";
    empty.innerHTML = `<div class="warn"><b>æ²’æœ‰ç¬¦åˆæ¢ä»¶çš„é æ¸¬ã€‚</b><br/>è©¦è©¦çœ‹æ¸…é™¤ TAG æˆ–æœå°‹å­—ã€‚</div>`;
    els.feed.appendChild(empty);
    return;
  }

  cacheFeed.forEach(pred=>{
    const tagName = TAGS.find(t=>t.key===pred.tag)?.name || pred.tag;
    const createdTxt = new Date(pred.createdAt).toLocaleDateString("zh-Hant", {year:"numeric", month:"2-digit", day:"2-digit"});

    const card = document.createElement("div");
    card.className = "card";
    card.innerHTML = `
      <div class="meta">
        <div class="leftmeta">
          <span class="tag">${esc(tagName)}</span>
          <span class="tag">çµç®—ï¼š${esc(pred.settleDate || "-")}</span>
          <span class="tag">å»ºç«‹ï¼š${createdTxt}</span>
        </div>
        <div class="muted">${hotLabel(ui.hot)}</div>
      </div>

      <div class="qtitle clickTitle" data-open="1">${esc(pred.title)}</div>

      ${pred.coverUrl ? `
        <div class="coverSquare" data-open="1">
          <div class="coverBox">
            <img src="${esc(pred.coverUrl)}" alt="cover" loading="lazy"
                 onerror="this.style.display='none'; this.closest('.coverSquare').style.display='none';" />
          </div>
        </div>
      ` : ""}

      <div class="muted" style="font-size:.78rem">
        ç¸½æŠ•ç¥¨/æ± ï¼ˆdemoï¼‰ï¼š<b style="color:var(--text)">${pred.totalVotes || 0}</b>
      </div>

      <div class="previewComments" id="pc-${pred.id}"></div>

      <div class="actions">
        <div class="inline">
          <span class="pill">â¤ï¸ ${pred.likes || 0}</span>
          <span class="pill">ğŸ’¬ ${pred.commentsCount || 0}</span>
          <span class="pill">æ’åºï¼š${hotLabel(ui.hot)}</span>
        </div>
        <div style="display:flex; gap:8px; flex-wrap:wrap;">
          <button class="btn primary" data-act="detail">æŸ¥çœ‹è©³æƒ…</button>
        </div>
      </div>
    `;

    card.querySelectorAll('[data-open="1"]').forEach(el=>{
      el.addEventListener("click", ()=> openDetail(pred.id));
    });
    card.querySelector('[data-act="detail"]').addEventListener("click", ()=> openDetail(pred.id));

    const pc = card.querySelector(`#pc-${pred.id}`);
    const top2 = pred.topComments || [];
    if(top2.length === 0){
      const d = document.createElement("div");
      d.className = "muted"; d.style.fontSize = ".85rem";
      d.textContent = "ç›®å‰é‚„æ²’æœ‰ç•™è¨€ã€‚";
      pc.appendChild(d);
    }else{
      top2.forEach(c=>{
        const expanded = !!ui.previewExpand?.[c.id];
        const {text, truncated} = expanded ? {text: String(c.text||""), truncated:false} : truncateText(c.text, 60);

        const div = document.createElement("div");
        div.className = "pcomment";
        div.innerHTML = `
          <div class="pcommentHead">
            <div>${esc(c.author)} Â· ${esc(fmtDate(c.createdAt))}</div>
            <div>â¤ï¸ ${c.likes}</div>
          </div>
          <div class="pcommentBody">${esc(text)}</div>
          ${(!expanded && truncated) ? `<button class="moreBtn" data-more="1">é¡¯ç¤ºæ›´å¤š</button>` : (expanded ? `<button class="moreBtn" data-less="1">æ”¶èµ·</button>` : "")}
        `;
        const more = div.querySelector("[data-more]");
        const less = div.querySelector("[data-less]");
        if(more){
          more.addEventListener("click", ()=>{
            ui.previewExpand ??= {};
            ui.previewExpand[c.id] = true;
            saveJSON(LS.ui, ui);
            renderAll();
          });
        }
        if(less){
          less.addEventListener("click", ()=>{
            ui.previewExpand ??= {};
            delete ui.previewExpand[c.id];
            saveJSON(LS.ui, ui);
            renderAll();
          });
        }
        pc.appendChild(div);
      });
    }

    els.feed.appendChild(card);
  });
}

function renderTrends(){
  els.trends.innerHTML = "";
  const list = cacheFeed.slice(0,6);
  if(list.length === 0){
    const div = document.createElement("div");
    div.className = "trend"; div.style.cursor="default";
    div.innerHTML = `<div class="t2">æ²’æœ‰ç†±é–€é …ç›®</div><div class="t3">æ¸…é™¤ TAG/æœå°‹å¾Œå†è©¦</div>`;
    els.trends.appendChild(div);
    return;
  }
  list.forEach((p,i)=>{
    const tagName = TAGS.find(t=>t.key===p.tag)?.name || p.tag;
    const div = document.createElement("div");
    div.className = "trend";
    div.innerHTML = `
      <div class="t1">${i+1} Â· ${esc(tagName)} Â· ${hotLabel(ui.hot)}</div>
      <div class="t2">${esc(p.title)}</div>
      <div class="t3">ç¸½æ± ï¼š${p.totalVotes || 0} Â· â¤ï¸ ${p.likes || 0}</div>
    `;
    div.addEventListener("click", ()=> openDetail(p.id));
    els.trends.appendChild(div);
  });
}

function renderDetail(){
  const pred = cacheDetail;
  if(!pred){
    els.detailCard.innerHTML = `<div class="warn"><b>å°šæœªè¼‰å…¥è©³æƒ…ã€‚</b></div>`;
    return;
  }
  const tagName = TAGS.find(t=>t.key===pred.tag)?.name || pred.tag;
  const totalVotes = pred.totalVotes || 0;

  els.detailCard.innerHTML = `
    <div class="actions" style="margin-top:0">
      <div class="inline">
        <button class="btn" id="detailBack">â† è¿”å›</button>
        <span class="pill">${esc(tagName)}</span>
        <span class="pill">ç¸½æ± ï¼š${totalVotes}</span>
      </div>
      <div style="display:flex; gap:8px; flex-wrap:wrap;">
        <button class="iconBtn ${pred.likedByMe ? "active":""}" id="detailLike">â¤ï¸ ${pred.likes}</button>
      </div>
    </div>

    <div class="split"></div>

    <div class="meta">
      <div class="leftmeta">
        <span class="tag">çµç®—ï¼š${esc(pred.settleDate || "-")}</span>
      </div>
      <div class="muted">IDï¼š<span class="mono">${esc(String(pred.id).slice(0,8))}</span></div>
    </div>

    <div class="qtitle">${esc(pred.title)}</div>

    ${pred.coverUrl ? `
      <div class="coverSquare">
        <div class="coverBox">
          <img src="${esc(pred.coverUrl)}" alt="cover" loading="lazy"
               onerror="this.style.display='none'; this.closest('.coverSquare').style.display='none';" />
        </div>
      </div>
    ` : ""}

    <div class="opts" id="detailOpts"></div>

    <div class="split"></div>

    <div class="muted" style="font-size:.78rem">ç•™è¨€ï¼ˆç†±é–€ / æœ€æ–° / å…¨éƒ¨ï¼‰</div>
    <div class="filters" style="margin-top:10px">
      <button class="chip active" data-ctab="hot">ç†±é–€ç•™è¨€</button>
      <button class="chip" data-ctab="new">æœ€æ–°ç•™è¨€</button>
      <button class="chip" data-ctab="all">å…¨éƒ¨</button>
    </div>

    <div class="split"></div>

    <div id="detailCommentList"></div>

    <div class="split"></div>

    <div class="field">
      <label>æ–°å¢ç•™è¨€</label>
      <textarea id="detailCommentInput" placeholder="è¼¸å…¥ç•™è¨€â€¦ï¼ˆéœ€ç™»å…¥ï¼‰" maxlength="300"></textarea>
    </div>
    <div class="actions">
      <div class="inline"><span class="pill">${me ? "ä½œè€…ï¼š" + esc(me.nick) : "æœªç™»å…¥"}</span></div>
      <button class="btn primary" id="detailSendComment">é€å‡º</button>
    </div>
  `;

  document.getElementById("detailBack").addEventListener("click", ()=>{
    ui.detailId = null; ui.page="predict";
    saveJSON(LS.ui, ui);
    setPage("predict");
  });

  document.getElementById("detailLike").addEventListener("click", async ()=>{
    if(!token) return openModal();
    await api(`/api/predictions/${encodeURIComponent(pred.id)}/like`, { method:"POST" });
    await loadDetail(pred.id);
    await loadFeed();
    renderAll();
  });

  // options
  const optsWrap = document.getElementById("detailOpts");
  pred.options.forEach(opt=>{
    const pct = totalVotes > 0 ? Math.round((opt.votes/totalVotes)*100) : 0;
    const el = document.createElement("div");
    el.className = "opt";
    el.innerHTML = `
      <div style="flex:1;">
        <div style="font-weight:800">${esc(opt.text)}</div>
        <div class="bar"><div style="width:${pct}%"></div></div>
      </div>
      <div class="rightmuted">${opt.votes}ï¼ˆ${pct}%ï¼‰</div>
    `;
    el.addEventListener("click", async ()=>{
      if(!token) return openModal();
      await api(`/api/predictions/${encodeURIComponent(pred.id)}/vote`, {
        method:"POST",
        body: JSON.stringify({ optionId: opt.id })
      });
      await loadDetail(pred.id);
      await loadFeed();
      renderAll();
    });
    optsWrap.appendChild(el);
  });

  // comment tabs (client-side sorting)
  let tab = "hot";
  const chips = els.detailCard.querySelectorAll("[data-ctab]");
  chips.forEach(c=>{
    c.addEventListener("click", ()=>{
      chips.forEach(x=>x.classList.remove("active"));
      c.classList.add("active");
      tab = c.dataset.ctab;
      renderCommentList();
    });
  });

  function renderCommentList(){
    const wrap = document.getElementById("detailCommentList");
    wrap.innerHTML = "";
    const list = (pred.comments || []).slice();
    if(tab === "hot") list.sort((a,b)=> (b.likes||0)-(a.likes||0) || (b.createdAt||0)-(a.createdAt||0));
    if(tab === "new") list.sort((a,b)=> (b.createdAt||0)-(a.createdAt||0));
    if(tab === "all") list.sort((a,b)=> (a.createdAt||0)-(b.createdAt||0));

    if(list.length === 0){
      const d = document.createElement("div");
      d.className = "muted"; d.textContent = "ç›®å‰é‚„æ²’æœ‰ç•™è¨€ã€‚";
      wrap.appendChild(d);
      return;
    }

    list.forEach(c=>{
      const div = document.createElement("div");
      div.className = "card";
      div.style.padding = "10px";
      div.innerHTML = `
        <div class="meta" style="margin-bottom:6px">
          <div class="leftmeta">
            <span class="tag">${esc(c.author)}</span>
            <span class="tag">${esc(fmtDate(c.createdAt))}</span>
          </div>
          <div class="muted">â¤ï¸ ${c.likes}</div>
        </div>
        <div style="font-size:.95rem">${esc(c.text)}</div>
        <div class="actions" style="margin-top:10px">
          <div class="inline"></div>
          <button class="iconBtn" data-like="1">â¤ï¸ æŒ‰è®š</button>
        </div>
      `;
      div.querySelector("[data-like]").addEventListener("click", async ()=>{
        if(!token) return openModal();
        await api(`/api/comments/${encodeURIComponent(c.id)}/like`, { method:"POST" });
        await loadDetail(pred.id);
        await loadFeed();
        renderAll();
      });
      wrap.appendChild(div);
    });
  }
  renderCommentList();

  document.getElementById("detailSendComment").addEventListener("click", async ()=>{
    if(!token) return openModal();
    const ta = document.getElementById("detailCommentInput");
    const text = (ta.value || "").trim();
    if(!text) return alert("ç•™è¨€ä¸èƒ½ç‚ºç©º");
    await api(`/api/predictions/${encodeURIComponent(pred.id)}/comments`, {
      method:"POST",
      body: JSON.stringify({ text })
    });
    ta.value = "";
    await loadDetail(pred.id);
    await loadFeed();
    renderAll();
  });
}

function fillProfile(){
  if(!me){
    els.pNick.value = "";
    els.pBio.value = "";
    els.pTier.value = "1";
    els.pLevel.value = "1";
    els.pWR.value = "50";
    els.profileNote.textContent = "è«‹å…ˆç™»å…¥";
    return;
  }
  els.pNick.value = me.nick || "";
  els.pBio.value = me.bio || "";
  els.pTier.value = String(me.tier || 1);
  els.pLevel.value = String(me.level || 1);
  els.pWR.value = String(me.winRate ?? 50);
  els.profileNote.textContent = "";
}

function renderAll(){
  renderMini();
  renderActiveTag();
  renderHotFilterState();
  syncLocalSettingsUI();

  // page specific
  if(ui.page === "predict"){
    renderFeed();
    renderTrends();
  }
  if(ui.page === "detail"){
    renderDetail();
  }
  if(ui.page === "publish"){
    renderPubTag();
    els.pubNote.textContent = token ? "" : "è«‹å…ˆç™»å…¥";
  }
  if(ui.page === "profile"){
    fillProfile();
  }
}

/** =========================
 *  Init
 * ========================= */
renderTagList();
(async ()=>{
  syncLocalSettingsUI();
  try{
    await loadMe();
  }catch{
    token=""; localStorage.removeItem(LS.token);
  }
  await loadFeed();
  setPage(ui.page || "predict");

  if(ui.page === "detail" && ui.detailId){
    await loadDetail(ui.detailId);
    renderAll();
  }
})();

window.addEventListener("keydown", (e)=>{
  if(e.key === "Escape"){ closeDrawer(); closeModal(); }
});
</script>
</body>
</html>
