<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>FEEx â€” Future Event Exchange</title>
  <style>
    :root{
      --bg:#000; --card:#0b0b0b; --card2:#111;
      --text:#eaeaea; --muted:#a8a8a8;
      --line:#222; --blue:#1d9bf0; --green:#18c964;
      --danger:#ff4d4d; --shadow: 0 10px 30px rgba(0,0,0,.35);
      --radius:16px;
      --fontSize: 16px;
    }
    *{box-sizing:border-box}
    body{
      margin:0; font-family: ui-sans-serif, system-ui, -apple-system, "Segoe UI", Roboto, "Noto Sans TC", Arial;
      background:var(--bg); color:var(--text); font-size:var(--fontSize);
    }
    a{color:inherit; text-decoration:none}
    button, input, textarea, select{font:inherit}
    .wrap{max-width:1100px; margin:0 auto; padding:0 12px;}
    .topbar{
      position:sticky; top:0; z-index:20;
      backdrop-filter: blur(10px);
      background: rgba(0,0,0,.7);
      border-bottom:1px solid var(--line);
    }
    .topbar .row{display:flex; align-items:center; justify-content:space-between; gap:10px; height:56px;}
    .brand{display:flex; align-items:center; gap:10px; font-weight:800; letter-spacing:.5px;}
    .pill{border:1px solid var(--line); border-radius:999px; padding:6px 10px; color:var(--muted); font-size:.9em;}
    .btn{
      border:1px solid var(--line); background:var(--card);
      color:var(--text); padding:10px 12px; border-radius:999px;
      cursor:pointer;
    }
    .btn.primary{background:var(--blue); border-color:transparent; color:#fff;}
    .btn.ghost{background:transparent;}
    .btn.danger{background:transparent; border-color:rgba(255,77,77,.6); color:#ff9a9a;}
    .btn:disabled{opacity:.6; cursor:not-allowed}
    .grid{
      display:grid; grid-template-columns: 280px 1fr 320px;
      gap:14px; padding:14px 0;
    }
    .card{
      background:var(--card);
      border:1px solid var(--line);
      border-radius:var(--radius);
      box-shadow: var(--shadow);
      overflow:hidden;
    }
    .card .hd{padding:12px 12px; border-bottom:1px solid var(--line); font-weight:700;}
    .card .bd{padding:12px;}
    .muted{color:var(--muted)}
    .nav a{
      display:flex; align-items:center; justify-content:space-between;
      padding:10px 12px; border-radius:12px; color:var(--text);
    }
    .nav a:hover{background:var(--card2)}
    .tagrow{display:flex; flex-wrap:wrap; gap:8px;}
    .tag{padding:6px 10px; border-radius:999px; border:1px solid var(--line); color:var(--muted); cursor:pointer}
    .tag.active{border-color:rgba(29,155,240,.7); color:#d8efff}
    .feedHd{
      display:flex; align-items:center; justify-content:space-between; gap:10px;
      padding:12px; border-bottom:1px solid var(--line);
    }
    .tabs{display:flex; gap:6px; flex-wrap:wrap}
    .tab{padding:8px 10px; border-radius:999px; border:1px solid var(--line); background:transparent; color:var(--muted); cursor:pointer}
    .tab.active{background:rgba(29,155,240,.18); border-color:rgba(29,155,240,.55); color:#d8efff}
    .search{flex:1; min-width:160px; display:flex; gap:8px; align-items:center;}
    .search input{
      width:100%; background:#070707; border:1px solid var(--line);
      color:var(--text); border-radius:999px; padding:10px 12px;
    }
    .post{
      border-bottom:1px solid var(--line);
      padding:12px;
      display:flex; gap:12px;
    }
    .avatar{
      width:42px; height:42px; border-radius:999px; background:#151515;
      border:1px solid var(--line);
      display:flex; align-items:center; justify-content:center;
      color:#cfcfcf; font-weight:800;
      flex:0 0 auto;
    }
    .post .meta{display:flex; gap:8px; flex-wrap:wrap; align-items:center;}
    .post .title{font-weight:800; margin:6px 0 8px; line-height:1.25}
    .kpi{display:flex; gap:14px; flex-wrap:wrap; color:var(--muted); font-size:.92em; margin-top:10px}
    .kpi button{all:unset; cursor:pointer; color:var(--muted)}
    .kpi button:hover{color:#fff}
    .cover{
      width:100%; max-height:320px; aspect-ratio: 1 / 1;
      background:#0d0d0d; border:1px solid var(--line);
      border-radius:14px; overflow:hidden;
      display:flex; align-items:center; justify-content:center;
      margin-top:10px;
    }
    .cover img{width:100%; height:100%; object-fit:cover; display:block}
    .topComments{
      margin-top:10px; border:1px solid var(--line); border-radius:14px; overflow:hidden;
      background:#0a0a0a;
    }
    .tcRow{padding:10px 12px; border-top:1px solid var(--line);}
    .tcRow:first-child{border-top:none}
    .tcRow .h{display:flex; justify-content:space-between; gap:8px; color:var(--muted); font-size:.92em}
    .tcRow .t{margin-top:6px; line-height:1.35}
    .more{color:#bfe6ff; cursor:pointer; margin-top:6px; display:inline-block}
    .panelRow{display:flex; gap:10px; align-items:center; justify-content:space-between; flex-wrap:wrap}
    .field{display:flex; flex-direction:column; gap:6px; margin:10px 0}
    input, textarea, select{
      background:#070707; border:1px solid var(--line);
      color:var(--text); border-radius:12px; padding:10px 12px;
      outline:none;
    }
    textarea{min-height:92px; resize:vertical}
    .hr{height:1px; background:var(--line); margin:12px 0}
    .toast{
      position:fixed; left:50%; transform:translateX(-50%);
      bottom:18px; z-index:50;
      background:#111; border:1px solid var(--line);
      border-radius:999px; padding:10px 14px; color:#fff;
      box-shadow: var(--shadow); max-width:90vw;
    }
    .modal{
      position:fixed; inset:0; background:rgba(0,0,0,.7);
      display:none; align-items:center; justify-content:center; z-index:60;
      padding:16px;
    }
    .modal.show{display:flex}
    .modal .box{
      width:min(720px, 96vw);
      background:var(--card);
      border:1px solid var(--line);
      border-radius:18px; overflow:hidden;
    }
    .modal .box .hd{display:flex; align-items:center; justify-content:space-between; padding:12px; border-bottom:1px solid var(--line); font-weight:800}
    .modal .box .bd{padding:12px}
    .split{display:grid; grid-template-columns: 1fr 1fr; gap:10px}
    .hide{display:none !important}

    /* Mobile */
    @media (max-width: 980px){
      .grid{grid-template-columns: 1fr; }
      .right, .left{display:none;}
      .topbar .pill{display:none;}
    }
    @media (max-width: 420px){
      .btn{padding:10px 10px}
      .avatar{width:38px;height:38px}
    }
  </style>
</head>
<body>
  <div class="topbar">
    <div class="wrap">
      <div class="row">
        <div class="brand">
          <span class="avatar" style="width:34px;height:34px;">F</span>
          <span>FEEx</span>
          <span class="pill" id="envPill">prod</span>
        </div>
        <div style="display:flex; gap:8px; align-items:center;">
          <button class="btn ghost" id="themeBtn" title="é–‹ç‡ˆ/é—œç‡ˆ">ğŸŒ™</button>
          <button class="btn" id="openProfileBtn">å€‹äºº</button>
          <button class="btn primary" id="openAuthBtn">ç™»å…¥/è¨»å†Š</button>
        </div>
      </div>
    </div>
  </div>

  <div class="wrap">
    <div class="grid">
      <!-- LEFT -->
      <div class="left card">
        <div class="hd">åˆ†é¡ TAG</div>
        <div class="bd">
          <div class="tagrow" id="tagRow"></div>
          <div class="hr"></div>
          <div class="nav">
            <a href="#" data-page="feed">ğŸ  <span class="muted">é¦–é </span></a>
            <a href="#" data-page="create">ğŸ§© <span class="muted">ç™¼å¸ƒé æ¸¬</span></a>
            <a href="#" data-page="rules">ğŸ“œ <span class="muted">è¦å‰‡&è¨­å®š</span></a>
          </div>
        </div>
      </div>

      <!-- CENTER -->
      <div class="card">
        <div class="feedHd">
          <div class="tabs" id="hotTabs"></div>
          <div class="search">
            <input id="qInput" placeholder="æœå°‹é¡Œç›®..." />
            <button class="btn" id="refreshBtn">åˆ·æ–°</button>
          </div>
        </div>

        <div id="pageFeed">
          <div id="feedList"></div>
        </div>

        <div id="pageCreate" class="hide">
          <div class="hd">ç™¼å¸ƒä¸€å€‹é æ¸¬</div>
          <div class="bd">
            <div class="muted" style="margin-bottom:10px">
              éœ€è¦æœƒå“¡ç­‰ç´š â‰¥ 4ï¼Œå»ºç«‹è²» 1000 GCï¼ˆç¤ºç¯„ï¼‰ã€‚å°é¢å¯è²¼æ­£æ–¹å½¢åœ–ç‰‡ç¶²å€ï¼ˆç¸®ç¶²å€ä¹Ÿå¯ï¼‰ã€‚
            </div>

            <div class="field">
              <label>é¡Œç›®</label>
              <input id="cTitle" placeholder="ä¾‹å¦‚ï¼š2026 ä¸–è¶³å† è»æœƒæ˜¯èª°ï¼Ÿ" />
            </div>

            <div class="split">
              <div class="field">
                <label>åˆ†é¡ TAG</label>
                <select id="cTag"></select>
              </div>
              <div class="field">
                <label>çµç®—æ—¥æœŸ</label>
                <input id="cSettle" placeholder="YYYY-MM-DD" />
              </div>
            </div>

            <div class="field">
              <label>å°é¢åœ–ï¼ˆURLï¼‰</label>
              <input id="cCover" placeholder="https://..." />
            </div>

            <div class="field">
              <label>é¸é …ï¼ˆ2~12 è¡Œï¼Œä¸€è¡Œä¸€å€‹ï¼‰</label>
              <textarea id="cOptions" placeholder="å·´è¥¿&#10;æ³•åœ‹&#10;é˜¿æ ¹å»·"></textarea>
            </div>

            <div class="panelRow">
              <button class="btn" id="adBtn">çœ‹å»£å‘Šæ‹¿ 100 GC</button>
              <button class="btn primary" id="createBtn">é€å‡ºé æ¸¬</button>
            </div>

            <div class="muted" id="createHint" style="margin-top:10px"></div>
          </div>
        </div>

        <div id="pageRules" class="hide">
          <div class="hd">è¦å‰‡ & è¨­å®š</div>
          <div class="bd">
            <div class="panelRow">
              <div>
                <div style="font-weight:800; margin-bottom:4px;">é¡¯ç¤ºè¨­å®š</div>
                <div class="muted">èª¿æ•´å­—é«”å¤§å°ã€ä¸»é¡Œæ¨¡å¼ï¼ˆç¤ºç¯„ï¼‰ã€‚</div>
              </div>
              <div style="display:flex; gap:8px;">
                <button class="btn" id="fontMinus">A-</button>
                <button class="btn" id="fontPlus">A+</button>
              </div>
            </div>

            <div class="hr"></div>

            <div style="font-weight:800; margin-bottom:6px;">çµ¦ä½¿ç”¨è€…çš„ä½¿ç”¨é¢¨éšªï¼ˆæ‘˜è¦ï¼‰</div>
            <ul class="muted" style="line-height:1.6; margin-top:6px;">
              <li>æœ¬å¹³å°ç‚ºå¨›æ¨‚/ç¤¾ç¾¤é æ¸¬ç”¨é€”ï¼›GC ç‚ºå¹³å°å…§é»æ•¸ï¼Œä¸å¯å…Œç¾ã€ä¸å¯ä¿è­‰åƒ¹å€¼ã€‚</li>
              <li>ä»»ä½•é æ¸¬çµæœå¯èƒ½å—åˆ°è³‡è¨Šä¸å®Œæ•´ã€æ“ä½œè¡Œç‚ºæˆ–äº‹ä»¶è®Šæ›´å½±éŸ¿ï¼Œè«‹è‡ªè¡Œåˆ¤æ–·ã€‚</li>
              <li>å¹³å°å¯åŸºæ–¼é˜²ä½œå¼Šèˆ‡æ²»ç†éœ€è¦èª¿æ•´è¦å‰‡ã€åƒæ•¸èˆ‡å…§å®¹å±•ç¤ºã€‚</li>
              <li>ä½¿ç”¨è€…éœ€å°è‡ªå·±çš„ç™¼è¨€ã€ç•™è¨€èˆ‡äº’å‹•å…§å®¹è² è²¬ã€‚</li>
            </ul>

            <div class="hr"></div>

            <div style="font-weight:800; margin-bottom:6px;">æ²»ç†èˆ‡åˆ†é…ï¼ˆç¤ºç¯„ï¼‰</div>
            <div class="muted" style="line-height:1.6;">
              äº‹ä»¶çµç®—å¾Œï¼šç™¼å¸ƒè€… 10%ï¼ŒéŠ·æ¯€ 5%ï¼Œå…¶é¤˜ 85% ä¾æŠ•å…¥æ¯”ä¾‹è¿”é‚„ï¼ˆç¤ºç¯„è¦å‰‡ï¼‰ã€‚
            </div>
          </div>
        </div>
      </div>

      <!-- RIGHT -->
      <div class="right card">
        <div class="hd">å¸³è™Ÿæ¦‚æ³</div>
        <div class="bd">
          <div id="meBox" class="muted">å°šæœªç™»å…¥</div>
          <div class="hr"></div>
          <button class="btn" id="logoutBtn">ç™»å‡º</button>
          <div class="hr"></div>

          <div style="font-weight:800; margin-bottom:8px;">Google ç™»å…¥ï¼ˆå¾…æ¥å¾Œç«¯ï¼‰</div>
          <button class="btn" id="googleBtn">ä½¿ç”¨ Google ç™»å…¥</button>
          <div class="muted" style="margin-top:8px; line-height:1.5;">
            ç›®å‰å¾Œç«¯å°šæœªæä¾› /api/login-googleï¼ˆæˆ– code äº¤æ›ï¼‰ç«¯é»ï¼Œé€™è£¡å…ˆé¡¯ç¤ºæŒ‰éˆ•èˆ‡æç¤ºã€‚
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- AUTH MODAL -->
  <div class="modal" id="authModal">
    <div class="box">
      <div class="hd">
        <span>ç™»å…¥ / è¨»å†Šï¼ˆEmailï¼‰</span>
        <button class="btn ghost" id="closeAuth">âœ•</button>
      </div>
      <div class="bd">
        <div class="split">
          <div class="card" style="box-shadow:none;">
            <div class="hd">è¨»å†Š</div>
            <div class="bd">
              <div class="field">
                <label>Email</label>
                <input id="rEmail" placeholder="name@example.com" />
              </div>
              <div class="field">
                <label>Password</label>
                <input id="rPass" type="password" placeholder="è‡³å°‘ 6 ç¢¼" />
              </div>
              <button class="btn primary" id="registerBtn" style="width:100%;">è¨»å†Š</button>
            </div>
          </div>

          <div class="card" style="box-shadow:none;">
            <div class="hd">ç™»å…¥</div>
            <div class="bd">
              <div class="field">
                <label>Email</label>
                <input id="lEmail" placeholder="name@example.com" />
              </div>
              <div class="field">
                <label>Password</label>
                <input id="lPass" type="password" placeholder="ä½ çš„å¯†ç¢¼" />
              </div>
              <button class="btn primary" id="loginBtn" style="width:100%;">ç™»å…¥</button>
              <div class="muted" style="margin-top:10px;">
                Google ç™»å…¥ç¨å¾Œå†æ¥ï¼ˆéœ€è¦å¾Œç«¯äº¤æ› tokenï¼‰ã€‚
              </div>
            </div>
          </div>
        </div>
        <div class="muted" style="margin-top:10px;" id="authHint"></div>
      </div>
    </div>
  </div>

  <!-- PROFILE MODAL -->
  <div class="modal" id="profileModal">
    <div class="box">
      <div class="hd">
        <span>å€‹äººæª”æ¡ˆ</span>
        <button class="btn ghost" id="closeProfile">âœ•</button>
      </div>
      <div class="bd">
        <div id="profileInfo" class="muted">å°šæœªç™»å…¥</div>

        <div class="hr"></div>

        <div class="field">
          <label>æš±ç¨±ï¼ˆ20 å­—å…§ï¼‰</label>
          <input id="pNick" placeholder="ä½ çš„æš±ç¨±" />
        </div>
        <div class="field">
          <label>å€‹äººç°½åï¼ˆ140 å­—å…§ï¼‰</label>
          <textarea id="pBio" placeholder="ä¸€å¥è©±ä»‹ç´¹è‡ªå·±"></textarea>
        </div>

        <div class="panelRow">
          <div class="panelRow" style="gap:8px;">
            <button class="btn" id="fontMinus2">A-</button>
            <button class="btn" id="fontPlus2">A+</button>
          </div>
          <button class="btn primary" id="saveProfileBtn">å„²å­˜</button>
        </div>
      </div>
    </div>
  </div>

  <!-- DETAIL MODAL -->
  <div class="modal" id="detailModal">
    <div class="box">
      <div class="hd">
        <span id="dTitle">è²¼æ–‡</span>
        <button class="btn ghost" id="closeDetail">âœ•</button>
      </div>
      <div class="bd" id="detailBody"></div>
    </div>
  </div>

  <div id="toast" class="toast hide"></div>

<script>
  // ====== CONFIG ======
  const API_BASE = "https://api.feex.win"; // â† ä½ å¯ä»¥æ”¹
  const TAGS = ["all","sports","world","politics","tech","finance","entertainment"];
  const HOTS = ["day","week","month","all"];

  // ====== STATE ======
  let state = {
    tag: "all",
    hot: "day",
    q: "",
    token: localStorage.getItem("feex_token") || "",
    me: null,
    theme: localStorage.getItem("feex_theme") || "dark",
    fontSize: parseInt(localStorage.getItem("feex_font") || "16", 10),
  };

  // ====== UI Helpers ======
  const $ = (id) => document.getElementById(id);
  const toast = (msg) => {
    const t = $("toast");
    t.textContent = msg;
    t.classList.remove("hide");
    clearTimeout(toast._tm);
    toast._tm = setTimeout(()=>t.classList.add("hide"), 2400);
  };

  function applyTheme(){
    document.documentElement.style.setProperty("--fontSize", state.fontSize+"px");
    if(state.theme === "light"){
      document.documentElement.style.setProperty("--bg","#f7f7f7");
      document.documentElement.style.setProperty("--card","#fff");
      document.documentElement.style.setProperty("--card2","#f1f1f1");
      document.documentElement.style.setProperty("--text","#0a0a0a");
      document.documentElement.style.setProperty("--muted","#5d5d5d");
      document.documentElement.style.setProperty("--line","#e2e2e2");
      $("themeBtn").textContent = "â˜€ï¸";
    }else{
      document.documentElement.style.setProperty("--bg","#000");
      document.documentElement.style.setProperty("--card","#0b0b0b");
      document.documentElement.style.setProperty("--card2","#111");
      document.documentElement.style.setProperty("--text","#eaeaea");
      document.documentElement.style.setProperty("--muted","#a8a8a8");
      document.documentElement.style.setProperty("--line","#222");
      $("themeBtn").textContent = "ğŸŒ™";
    }
  }

  function setPage(p){
    $("pageFeed").classList.toggle("hide", p!=="feed");
    $("pageCreate").classList.toggle("hide", p!=="create");
    $("pageRules").classList.toggle("hide", p!=="rules");
  }

  function initials(nick){
    const s = (nick||"U").trim();
    return s.slice(0,1).toUpperCase();
  }

  function fmtDate(ms){
    try{
      const d = new Date(Number(ms));
      if(!Number.isFinite(d.getTime())) return "";
      return d.toISOString().slice(0,10);
    }catch{ return ""; }
  }

  // ====== API ======
  async function api(path, opts={}){
    const headers = Object.assign({"Content-Type":"application/json"}, opts.headers||{});
    if(state.token) headers["Authorization"] = "Bearer "+state.token;
    const res = await fetch(API_BASE + path, {...opts, headers});
    const data = await res.json().catch(()=>({ok:false,error:"Bad JSON"}));
    if(!res.ok && !data?.error) data.error = "HTTP "+res.status;
    return data;
  }

  async function loadMe(){
    if(!state.token){ state.me=null; renderMe(); return; }
    const data = await api("/api/me", {method:"GET"});
    if(!data.ok){
      state.me = null;
      renderMe();
      return;
    }
    state.me = data.user;
    renderMe();
  }

  function renderMe(){
    if(!state.me){
      $("meBox").innerHTML = "å°šæœªç™»å…¥";
      $("openAuthBtn").textContent = "ç™»å…¥/è¨»å†Š";
      return;
    }
    $("openAuthBtn").textContent = "å·²ç™»å…¥";
    $("meBox").innerHTML = `
      <div style="font-weight:800; font-size:1.05em;">${escapeHtml(state.me.nick)}</div>
      <div class="muted">${escapeHtml(state.me.email)}</div>
      <div class="hr"></div>
      <div class="muted">Tierï¼š${state.me.tier}ã€€Lvï¼š${state.me.level}</div>
      <div class="muted">å‹ç‡ï¼š${state.me.winRate}%ã€€GCï¼š${state.me.gc}</div>
    `;
    $("profileInfo").innerHTML = `
      <div style="display:flex; gap:10px; align-items:center;">
        <div class="avatar">${initials(state.me.nick)}</div>
        <div>
          <div style="font-weight:800;">${escapeHtml(state.me.nick)}</div>
          <div class="muted">${escapeHtml(state.me.bio||"")}</div>
        </div>
      </div>
    `;
    $("pNick").value = state.me.nick || "";
    $("pBio").value = state.me.bio || "";
  }

  async function loadFeed(){
    $("feedList").innerHTML = `<div class="bd muted">è¼‰å…¥ä¸­...</div>`;
    const q = state.q ? `&q=${encodeURIComponent(state.q)}` : "";
    const data = await api(`/api/predictions?tag=${encodeURIComponent(state.tag)}&hot=${encodeURIComponent(state.hot)}${q}`, {method:"GET"});
    if(!data.ok){
      $("feedList").innerHTML = `<div class="bd" style="color:#ff9a9a;">è¼‰å…¥å¤±æ•—ï¼š${escapeHtml(data.error||"")}</div>`;
      return;
    }
    const list = data.predictions || [];
    if(!list.length){
      $("feedList").innerHTML = `<div class="bd muted">ç›®å‰æ²’æœ‰å…§å®¹</div>`;
      return;
    }
    $("feedList").innerHTML = list.map(renderPost).join("");
    // bind events
    list.forEach(p=>{
      const likeBtn = document.querySelector(`[data-like="${p.id}"]`);
      if(likeBtn) likeBtn.addEventListener("click", ()=>toggleLike(p.id));
      const openBtn = document.querySelector(`[data-open="${p.id}"]`);
      if(openBtn) openBtn.addEventListener("click", ()=>openDetail(p.id));
    });
  }

  function renderPost(p){
    const top = Array.isArray(p.topComments) ? p.topComments : [];
    const topHtml = top.length ? `
      <div class="topComments">
        ${top.map(tc=>{
          const raw = tc.text || "";
          const short = raw.length > 70 ? raw.slice(0,70) + "â€¦" : raw;
          const needMore = raw.length > 70;
          return `
          <div class="tcRow">
            <div class="h">
              <span>@${escapeHtml(tc.author||"User")}</span>
              <span>â™¥ ${Number(tc.likes||0)}</span>
            </div>
            <div class="t" data-tc="${tc.id}" data-full="${escapeAttr(raw)}">${escapeHtml(short)}</div>
            ${needMore ? `<span class="more" data-more="${tc.id}">é¡¯ç¤ºæ›´å¤š</span>` : ``}
          </div>`;
        }).join("")}
      </div>
    ` : ``;

    // bind "show more" after insertion (delegation)
    setTimeout(()=>{
      document.querySelectorAll("[data-more]").forEach(el=>{
        el.onclick = () => {
          const id = el.getAttribute("data-more");
          const t = document.querySelector(`[data-tc="${id}"]`);
          if(!t) return;
          t.textContent = t.getAttribute("data-full") || t.textContent;
          el.remove();
        };
      });
    }, 0);

    return `
      <div class="post">
        <div class="avatar">${initials(p.ownerNick || "U")}</div>
        <div style="flex:1; min-width:0;">
          <div class="meta">
            <span style="font-weight:800;">@${escapeHtml(p.ownerNick || "User")}</span>
            <span class="muted">Â·</span>
            <span class="muted">${escapeHtml(p.tag||"")}</span>
            <span class="muted">Â·</span>
            <span class="muted">çµç®— ${escapeHtml(p.settleDate||"")}</span>
          </div>
          <div class="title">${escapeHtml(p.title||"")}</div>

          ${p.coverUrl ? `
            <div class="cover">
              <img src="${escapeAttr(p.coverUrl)}" alt="cover" loading="lazy" />
            </div>
          ` : ""}

          <div class="kpi">
            <button data-open="${p.id}">ğŸ’¬ ${Number(p.commentsCount||0)}</button>
            <button data-like="${p.id}">â™¥ ${Number(p.likes||0)}</button>
            <span>ğŸ—³ ${Number(p.totalVotes||0)}</span>
          </div>

          ${topHtml}

          <div style="margin-top:10px;">
            <button class="btn" data-open="${p.id}">æŸ¥çœ‹å®Œæ•´å…§å®¹</button>
          </div>
        </div>
      </div>
    `;
  }

  async function toggleLike(predId){
    if(!state.token) return toast("è«‹å…ˆç™»å…¥");
    const data = await api(`/api/predictions/${predId}/like`, {method:"POST"});
    if(!data.ok) return toast(data.error||"å¤±æ•—");
    await loadFeed();
  }

  async function openDetail(predId){
    const d = $("detailModal");
    d.classList.add("show");
    $("detailBody").innerHTML = `<div class="muted">è¼‰å…¥ä¸­...</div>`;
    const data = await api(`/api/predictions/${predId}`, {method:"GET"});
    if(!data.ok){
      $("detailBody").innerHTML = `<div style="color:#ff9a9a;">è¼‰å…¥å¤±æ•—ï¼š${escapeHtml(data.error||"")}</div>`;
      return;
    }
    const p = data.prediction;
    $("dTitle").textContent = p.title || "è²¼æ–‡";

    const opts = (p.options||[]).map(o=>`
      <div class="panelRow" style="border:1px solid var(--line); padding:10px 12px; border-radius:14px; margin:8px 0;">
        <div style="min-width:0;">
          <div style="font-weight:700;">${escapeHtml(o.text)}</div>
          <div class="muted">ç¥¨æ•¸ï¼š${Number(o.votes||0)}</div>
        </div>
        <button class="btn" data-vote="${o.id}">æŠ•ç¥¨</button>
      </div>
    `).join("");

    const cm = (p.comments||[]).map(c=>`
      <div style="border-top:1px solid var(--line); padding:10px 0;">
        <div class="panelRow">
          <div class="muted">@${escapeHtml(c.author||"User")} Â· ${escapeHtml(fmtDate(c.createdAt)||"")}</div>
          <button class="btn" data-likec="${c.id}">â™¥ ${Number(c.likes||0)}</button>
        </div>
        <div style="margin-top:6px; line-height:1.5;">${escapeHtml(c.text||"")}</div>
      </div>
    `).join("") || `<div class="muted">é‚„æ²’æœ‰ç•™è¨€</div>`;

    $("detailBody").innerHTML = `
      <div class="muted">${escapeHtml(p.tag||"")} Â· çµç®— ${escapeHtml(p.settleDate||"")}</div>
      ${p.coverUrl ? `<div class="cover" style="margin-top:10px;"><img src="${escapeAttr(p.coverUrl)}" /></div>` : ""}

      <div class="hr"></div>
      <div style="font-weight:800;">æŠ•ç¥¨</div>
      <div class="muted">ä½ åªèƒ½æŠ•ä¸€æ¬¡ï¼ˆç¤ºç¯„ï¼‰ã€‚</div>
      ${opts}

      <div class="hr"></div>
      <div style="font-weight:800; margin-bottom:6px;">ç•™è¨€</div>
      <div class="field">
        <textarea id="cmtText" placeholder="å¯«ä¸‹ä½ çš„çœ‹æ³•ï¼ˆ300å­—å…§ï¼‰"></textarea>
      </div>
      <div class="panelRow">
        <button class="btn" id="postCmtBtn">é€å‡ºç•™è¨€</button>
        <button class="btn" id="refreshDetailBtn">åˆ·æ–°</button>
      </div>

      <div class="hr"></div>
      <div style="font-weight:800;">ç†±é–€/æœ€æ–°ç•™è¨€</div>
      ${cm}
    `;

    document.querySelectorAll("[data-vote]").forEach(btn=>{
      btn.onclick = async ()=>{
        if(!state.token) return toast("è«‹å…ˆç™»å…¥");
        const optionId = btn.getAttribute("data-vote");
        const r = await api(`/api/predictions/${predId}/vote`, {method:"POST", body: JSON.stringify({optionId})});
        if(!r.ok) return toast(r.error||"æŠ•ç¥¨å¤±æ•—");
        toast("æŠ•ç¥¨æˆåŠŸ");
        await openDetail(predId);
        await loadFeed();
      };
    });

    document.querySelectorAll("[data-likec]").forEach(btn=>{
      btn.onclick = async ()=>{
        if(!state.token) return toast("è«‹å…ˆç™»å…¥");
        const cid = btn.getAttribute("data-likec");
        const r = await api(`/api/comments/${cid}/like`, {method:"POST"});
        if(!r.ok) return toast(r.error||"å¤±æ•—");
        await openDetail(predId);
        await loadFeed();
      };
    });

    $("postCmtBtn").onclick = async ()=>{
      if(!state.token) return toast("è«‹å…ˆç™»å…¥");
      const text = ($("cmtText").value||"").trim();
      const r = await api(`/api/predictions/${predId}/comments`, {method:"POST", body: JSON.stringify({text})});
      if(!r.ok) return toast(r.error||"ç•™è¨€å¤±æ•—");
      toast("å·²ç•™è¨€");
      await openDetail(predId);
      await loadFeed();
    };

    $("refreshDetailBtn").onclick = async ()=>{
      await openDetail(predId);
    };
  }

  function escapeHtml(s){
    return String(s ?? "")
      .replaceAll("&","&amp;").replaceAll("<","&lt;")
      .replaceAll(">","&gt;").replaceAll('"',"&quot;")
      .replaceAll("'","&#039;");
  }
  function escapeAttr(s){ return escapeHtml(s).replaceAll("\n"," "); }

  // ====== INIT UI ======
  function initTags(){
    const row = $("tagRow");
    row.innerHTML = TAGS.map(t=>`<span class="tag ${t===state.tag?"active":""}" data-tag="${t}">${t}</span>`).join("");
    row.querySelectorAll("[data-tag]").forEach(el=>{
      el.onclick = ()=>{ state.tag = el.getAttribute("data-tag"); initTags(); loadFeed(); };
    });

    const sel = $("cTag");
    sel.innerHTML = TAGS.filter(t=>t!=="all").map(t=>`<option value="${t}">${t}</option>`).join("");
  }

  function initHotTabs(){
    const row = $("hotTabs");
    row.innerHTML = HOTS.map(h=>`<button class="tab ${h===state.hot?"active":""}" data-hot="${h}">${h==="day"?"ç•¶æ—¥ç†±é–€":h==="week"?"æœ¬é€±ç†±é–€":h==="month"?"æœ¬æœˆç†±é–€":"ç¸½ç†±é–€"}</button>`).join("");
    row.querySelectorAll("[data-hot]").forEach(el=>{
      el.onclick = ()=>{ state.hot = el.getAttribute("data-hot"); initHotTabs(); loadFeed(); };
    });
  }

  function initNav(){
    document.querySelectorAll(".nav a[data-page]").forEach(a=>{
      a.onclick = (e)=>{
        e.preventDefault();
        setPage(a.getAttribute("data-page"));
      };
    });
  }

  // ====== ACTIONS ======
  $("refreshBtn").onclick = ()=>loadFeed();
  $("qInput").onkeydown = (e)=>{
    if(e.key==="Enter"){
      state.q = $("qInput").value.trim();
      loadFeed();
    }
  };

  $("openAuthBtn").onclick = ()=>$("authModal").classList.add("show");
  $("closeAuth").onclick = ()=>$("authModal").classList.remove("show");
  $("openProfileBtn").onclick = ()=>$("profileModal").classList.add("show");
  $("closeProfile").onclick = ()=>$("profileModal").classList.remove("show");
  $("closeDetail").onclick = ()=>$("detailModal").classList.remove("show");

  $("logoutBtn").onclick = ()=>{
    state.token = "";
    localStorage.removeItem("feex_token");
    state.me = null;
    renderMe();
    toast("å·²ç™»å‡º");
  };

  $("themeBtn").onclick = ()=>{
    state.theme = (state.theme==="dark") ? "light" : "dark";
    localStorage.setItem("feex_theme", state.theme);
    applyTheme();
  };

  function bumpFont(delta){
    state.fontSize = Math.max(12, Math.min(22, state.fontSize + delta));
    localStorage.setItem("feex_font", String(state.fontSize));
    applyTheme();
  }
  $("fontMinus").onclick = ()=>bumpFont(-1);
  $("fontPlus").onclick = ()=>bumpFont(+1);
  $("fontMinus2").onclick = ()=>bumpFont(-1);
  $("fontPlus2").onclick = ()=>bumpFont(+1);

  $("googleBtn").onclick = ()=>{
    toast("Google ç™»å…¥ï¼šéœ€è¦å¾Œç«¯æ–°å¢ /api/login-google æ‰èƒ½å®Œæˆ");
  };

  $("registerBtn").onclick = async ()=>{
    const email = $("rEmail").value.trim();
    const password = $("rPass").value;
    const r = await api("/api/register", {method:"POST", body: JSON.stringify({email, password})});
    $("authHint").textContent = r.ok ? "è¨»å†ŠæˆåŠŸï¼Œè«‹ç›´æ¥ç™»å…¥ã€‚" : ("è¨»å†Šå¤±æ•—ï¼š"+(r.error||""));
    if(r.ok) toast("è¨»å†ŠæˆåŠŸ");
  };

  $("loginBtn").onclick = async ()=>{
    const email = $("lEmail").value.trim();
    const password = $("lPass").value;
    const r = await api("/api/login", {method:"POST", body: JSON.stringify({email, password})});
    if(!r.ok){ $("authHint").textContent = "ç™»å…¥å¤±æ•—ï¼š"+(r.error||""); return; }
    state.token = r.token;
    localStorage.setItem("feex_token", state.token);
    $("authModal").classList.remove("show");
    toast("ç™»å…¥æˆåŠŸ");
    await loadMe();
    await loadFeed();
  };

  $("saveProfileBtn").onclick = async ()=>{
    if(!state.token) return toast("è«‹å…ˆç™»å…¥");
    const nick = $("pNick").value.trim();
    const bio = $("pBio").value.trim();
    const r = await api("/api/me", {method:"PATCH", body: JSON.stringify({nick, bio})});
    if(!r.ok) return toast(r.error||"å„²å­˜å¤±æ•—");
    state.me = r.user;
    toast("å·²æ›´æ–°");
    renderMe();
    await loadFeed();
  };

  $("adBtn").onclick = async ()=>{
    if(!state.token) return toast("è«‹å…ˆç™»å…¥");
    const r = await api("/api/claim-ad", {method:"POST"});
    if(!r.ok){
      if(r.error==="Cooldown") return toast("å†·å»ä¸­ï¼Œç¨å¾Œå†è©¦");
      return toast(r.error||"å¤±æ•—");
    }
    toast(`ç²å¾— ${r.reward} GCï¼Œæ–°é¤˜é¡ ${r.newBalance}`);
    await loadMe();
  };

  $("createBtn").onclick = async ()=>{
    if(!state.token) return toast("è«‹å…ˆç™»å…¥");
    const title = $("cTitle").value.trim();
    const tag = $("cTag").value;
    const settleDate = $("cSettle").value.trim();
    const coverUrl = $("cCover").value.trim();
    const options = $("cOptions").value.split("\n").map(s=>s.trim()).filter(Boolean);
    const r = await api("/api/predictions", {method:"POST", body: JSON.stringify({title, tag, settleDate, coverUrl, options})});
    if(!r.ok){ $("createHint").textContent = "å¤±æ•—ï¼š"+(r.error||""); return toast(r.error||"å¤±æ•—"); }
    $("createHint").textContent = "å·²å»ºç«‹ï¼";
    toast("å·²å»ºç«‹é æ¸¬");
    setPage("feed");
    await loadMe();
    await loadFeed();
  };

  // ====== BOOT ======
  (async function boot(){
    $("envPill").textContent = API_BASE.includes("127.0.0.1") ? "dev" : "prod";
    applyTheme();
    initTags();
    initHotTabs();
    initNav();
    setPage("feed");
    await loadMe();
    await loadFeed();
  })();
</script>
</body>
</html>
