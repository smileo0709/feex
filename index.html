<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>FEEx â€” Future Event Exchange</title>
  <meta name="theme-color" content="#000000" />
  <style>
    :root{
      --bg:#000;
      --panel:#0b0b0b;
      --panel2:#111;
      --border:#242424;
      --text:#e7e7e7;
      --muted:#9aa0a6;
      --brand:#1d9bf0; /* X è— */
      --good:#2dd4bf;
      --bad:#fb7185;
      --shadow: 0 10px 30px rgba(0,0,0,.55);
      --radius:16px;
      --fontScale: 1;
      --maxw: 1240px;
      --colLeft: 270px;
      --colRight: 340px;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      background:var(--bg);
      color:var(--text);
      font-family: ui-sans-serif, system-ui, -apple-system, "Segoe UI", Roboto, "Noto Sans TC", "PingFang TC", "Microsoft JhengHei", Arial, sans-serif;
      font-size: calc(15px * var(--fontScale));
      line-height:1.45;
    }
    a{color:inherit; text-decoration:none}
    button,input,select,textarea{font:inherit; color:inherit}
    .app{
      max-width:var(--maxw);
      margin:0 auto;
      display:grid;
      grid-template-columns: var(--colLeft) minmax(0,1fr) var(--colRight);
      gap:18px;
      padding: 14px 14px 40px;
    }
    /* Top bar (mobile) */
    .topbar{
      position:sticky; top:0; z-index:40;
      backdrop-filter: blur(10px);
      background: rgba(0,0,0,.75);
      border-bottom:1px solid var(--border);
      padding: 10px 12px;
      display:none;
      align-items:center;
      gap:10px;
    }
    .iconBtn{
      border:1px solid var(--border);
      background:rgba(255,255,255,.04);
      padding:8px 10px;
      border-radius:999px;
      cursor:pointer;
    }
    .brand{
      display:flex; align-items:center; gap:10px; min-width:0;
      font-weight:800;
    }
    .brand .dot{
      width:10px; height:10px; border-radius:50%;
      background:var(--brand);
      box-shadow: 0 0 0 6px rgba(29,155,240,.15);
    }
    .brand .name{white-space:nowrap; overflow:hidden; text-overflow:ellipsis}
    .pill{
      border:1px solid var(--border);
      background:rgba(255,255,255,.03);
      padding:7px 10px;
      border-radius:999px;
      color:var(--muted);
      cursor:pointer;
      white-space:nowrap;
    }
    .pill.active{border-color:rgba(29,155,240,.45); color:var(--text); background:rgba(29,155,240,.10)}
    .card{
      border:1px solid var(--border);
      background:linear-gradient(180deg, rgba(255,255,255,.04), rgba(255,255,255,.02));
      border-radius:var(--radius);
      overflow:hidden;
      box-shadow: var(--shadow);
    }
    .panel{
      border:1px solid var(--border);
      background:rgba(255,255,255,.03);
      border-radius:var(--radius);
      overflow:hidden;
    }
    .left, .right{position:sticky; top:14px; height:calc(100dvh - 28px); overflow:auto}
    .left::-webkit-scrollbar,.right::-webkit-scrollbar{width:8px}
    .left::-webkit-scrollbar-thumb,.right::-webkit-scrollbar-thumb{background:#1f1f1f;border-radius:999px}

    .nav{
      padding:12px;
      display:flex;
      flex-direction:column;
      gap:10px;
    }
    .nav .navItem{
      display:flex; align-items:center; justify-content:space-between;
      padding:10px 12px;
      border-radius:12px;
      cursor:pointer;
      border:1px solid transparent;
      background:transparent;
    }
    .nav .navItem:hover{background:rgba(255,255,255,.04)}
    .nav .navItem.active{border-color:rgba(29,155,240,.45); background:rgba(29,155,240,.10)}
    .nav .sub{color:var(--muted); font-size:.9em}

    .sectionTitle{
      padding:12px 14px;
      border-bottom:1px solid var(--border);
      display:flex; align-items:center; justify-content:space-between;
      gap:10px;
      background:rgba(255,255,255,.02);
    }
    .sectionTitle h3{margin:0; font-size:1em}
    .row{display:flex; gap:8px; align-items:center; flex-wrap:wrap}
    .btn{
      border:1px solid var(--border);
      background:rgba(255,255,255,.04);
      padding:9px 12px;
      border-radius:12px;
      cursor:pointer;
    }
    .btn:hover{background:rgba(255,255,255,.06)}
    .btn.brand{border-color:rgba(29,155,240,.45); background:rgba(29,155,240,.12)}
    .btn.brand:hover{background:rgba(29,155,240,.18)}
    .btn.danger{border-color:rgba(251,113,133,.45); background:rgba(251,113,133,.12)}
    .btn.good{border-color:rgba(45,212,191,.45); background:rgba(45,212,191,.10)}
    .btn.small{padding:7px 10px; border-radius:10px; font-size:.92em}
    .muted{color:var(--muted)}
    .divider{height:1px; background:var(--border)}
    .input, .select, .textarea{
      width:100%;
      border:1px solid var(--border);
      background:rgba(0,0,0,.35);
      border-radius:12px;
      padding:10px 12px;
      outline:none;
    }
    .textarea{min-height:90px; resize:vertical}
    .grid2{display:grid; grid-template-columns:1fr 1fr; gap:10px}
    .grid3{display:grid; grid-template-columns:1fr 1fr 1fr; gap:10px}

    /* Center column */
    .center{min-width:0}
    .composer{
      padding:14px;
      display:flex;
      gap:12px;
      align-items:flex-start;
    }
    .avatar{
      width:44px; height:44px; border-radius:50%;
      background: radial-gradient(circle at 30% 20%, rgba(29,155,240,.6), rgba(255,255,255,.06));
      border:1px solid rgba(255,255,255,.12);
      flex:0 0 auto;
    }
    .composerMain{flex:1; min-width:0}
    .tabs{
      display:flex; gap:8px; flex-wrap:wrap;
      padding:12px 14px;
      border-bottom:1px solid var(--border);
      position:sticky; top:0; z-index:30;
      background: rgba(0,0,0,.75);
      backdrop-filter: blur(10px);
    }

    .feed{display:flex; flex-direction:column}
    .post{
      padding:14px;
      display:flex;
      gap:12px;
      border-bottom:1px solid var(--border);
      cursor:pointer;
    }
    .post:hover{background:rgba(255,255,255,.02)}
    .postMain{flex:1; min-width:0}
    .postHead{
      display:flex; justify-content:space-between; gap:12px; align-items:flex-start;
    }
    .postMeta{
      display:flex; gap:8px; flex-wrap:wrap; align-items:center;
      font-size:.92em;
    }
    .badge{
      font-size:.82em;
      padding:3px 8px;
      border-radius:999px;
      border:1px solid var(--border);
      color:var(--muted);
      background:rgba(255,255,255,.03);
      white-space:nowrap;
    }
    .title{
      margin:6px 0 10px;
      font-size:1.05em;
      font-weight:800;
      word-break:break-word;
    }
    .cover{
      width:100%;
      aspect-ratio:1 / 1; /* æ­£æ–¹å½¢ */
      border-radius:14px;
      border:1px solid var(--border);
      background:#070707;
      overflow:hidden;
      display:flex;
      align-items:center;
      justify-content:center;
      margin-top:10px;
    }
    .cover img{
      width:100%;
      height:100%;
      object-fit:cover;
      object-position:center;
      display:block;
    }
    .actions{
      margin-top:10px;
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      align-items:center;
    }
    .chip{
      display:inline-flex; gap:8px; align-items:center;
      padding:7px 10px;
      border-radius:999px;
      border:1px solid var(--border);
      background:rgba(255,255,255,.03);
      color:var(--muted);
      font-size:.92em;
      cursor:pointer;
    }
    .chip:hover{background:rgba(255,255,255,.05)}
    .chip.liked{border-color:rgba(251,113,133,.45); color:var(--text); background:rgba(251,113,133,.10)}
    .chip.primary{border-color:rgba(29,155,240,.45); color:var(--text); background:rgba(29,155,240,.10)}
    .top2{
      margin-top:10px;
      display:flex;
      flex-direction:column;
      gap:8px;
    }
    .tweetPreview{
      border:1px solid var(--border);
      background:rgba(255,255,255,.02);
      border-radius:14px;
      padding:10px 12px;
    }
    .tweetPreview .who{font-weight:800; font-size:.95em}
    .tweetPreview .txt{margin-top:4px; color:var(--text); font-size:.95em; word-break:break-word}
    .moreBtn{margin-top:6px; color:var(--brand); font-weight:700; cursor:pointer; display:inline-block}

    /* Modal */
    .backdrop{
      position:fixed; inset:0; z-index:60;
      background: rgba(0,0,0,.72);
      display:none;
      align-items:center;
      justify-content:center;
      padding:16px;
    }
    .backdrop.show{display:flex}
    .modal{
      width:min(980px, 100%);
      max-height: min(92dvh, 920px);
      overflow:auto;
      border:1px solid var(--border);
      border-radius: 18px;
      background: rgba(10,10,10,.96);
      box-shadow: var(--shadow);
    }
    .modalHeader{
      position:sticky; top:0; z-index:10;
      display:flex; justify-content:space-between; align-items:center; gap:10px;
      padding:12px 14px;
      border-bottom:1px solid var(--border);
      backdrop-filter: blur(10px);
      background: rgba(10,10,10,.92);
    }
    .modalHeader .x{cursor:pointer; padding:6px 10px; border-radius:999px; border:1px solid var(--border); background:rgba(255,255,255,.03)}
    .modalBody{padding:14px}
    .twoCol{display:grid; grid-template-columns: 1.05fr .95fr; gap:14px}
    .kpi{display:grid; grid-template-columns: repeat(3,1fr); gap:10px}
    .kpi .box{border:1px solid var(--border); background:rgba(255,255,255,.02); border-radius:14px; padding:10px}
    .kpi .box .v{font-weight:900; font-size:1.15em}
    .kpi .box .k{color:var(--muted); font-size:.9em}

    .googleBtn{
      width:100%;
      display:flex; align-items:center; justify-content:center; gap:10px;
      padding:10px 12px;
      border-radius:12px;
      border:1px solid rgba(255,255,255,.18);
      background:rgba(255,255,255,.06);
      cursor:pointer;
      font-weight:800;
    }
    .googleBtn:hover{background:rgba(255,255,255,.09)}
    .gIcon{
      width:18px; height:18px; border-radius:4px;
      background: conic-gradient(from 45deg, #ea4335, #fbbc05, #34a853, #4285f4, #ea4335);
    }

    /* Drawer (mobile tags) */
    .drawer{
      position:fixed; inset:0; z-index:70;
      display:none;
    }
    .drawer.show{display:block}
    .drawer .shade{position:absolute; inset:0; background:rgba(0,0,0,.72)}
    .drawer .sheet{
      position:absolute; left:0; top:0; bottom:0;
      width:min(360px, 86vw);
      background:rgba(10,10,10,.98);
      border-right:1px solid var(--border);
      box-shadow: var(--shadow);
      padding:12px;
      overflow:auto;
    }

    /* Responsive */
    @media (max-width: 1060px){
      :root{ --colRight: 300px; --colLeft: 250px; }
    }
    @media (max-width: 920px){
      .app{grid-template-columns: 1fr; padding:0 0 60px}
      .left,.right{display:none}
      .topbar{display:flex}
      .tabs{top:52px}
      .center{padding:0 12px}
      .card{border-radius:18px}
    }
  </style>
</head>
<body>
  <div class="topbar">
    <button class="iconBtn" id="btnOpenDrawer">â˜°</button>
    <div class="brand">
      <div class="dot"></div>
      <div class="name">FEEx</div>
    </div>
    <div style="flex:1"></div>
    <button class="iconBtn" id="btnOpenAuth">ç™»å…¥</button>
  </div>

  <div class="drawer" id="drawer">
    <div class="shade" id="drawerShade"></div>
    <div class="sheet">
      <div class="brand" style="padding:8px 4px 14px;">
        <div class="dot"></div>
        <div class="name">FEEx</div>
      </div>
      <div class="panel">
        <div class="sectionTitle"><h3>åˆ†é </h3></div>
        <div class="nav" id="mobileNav"></div>
      </div>
      <div style="height:12px"></div>
      <div class="panel">
        <div class="sectionTitle"><h3>TAG</h3></div>
        <div class="nav" id="mobileTags"></div>
      </div>
      <div style="height:12px"></div>
      <button class="btn" id="btnCloseDrawer" style="width:100%">é—œé–‰</button>
    </div>
  </div>

  <div class="app">
    <!-- Left -->
    <aside class="left">
      <div class="panel">
        <div class="sectionTitle">
          <div class="brand" style="gap:8px">
            <div class="dot"></div>
            <div class="name">FEEx</div>
          </div>
          <button class="btn small" id="btnAuthLeft">ç™»å…¥</button>
        </div>
        <div class="nav" id="leftNav"></div>
      </div>

      <div style="height:12px"></div>

      <div class="panel">
        <div class="sectionTitle">
          <h3>TAG</h3>
          <span class="muted" style="font-size:.9em">åˆ†é¡</span>
        </div>
        <div class="nav" id="tagNav"></div>
      </div>

      <div style="height:12px"></div>

      <div class="panel">
        <div class="sectionTitle">
          <h3>å¿«æ·</h3>
        </div>
        <div class="nav">
          <button class="navItem" id="btnLight">
            <div>
              <div style="font-weight:800">é–‹ç‡ˆ / é—œç‡ˆ</div>
              <div class="sub">åˆ‡æ›äº®åº¦ï¼ˆdemoï¼‰</div>
            </div>
            <div class="badge">UI</div>
          </button>
          <button class="navItem" id="btnFontReset">
            <div>
              <div style="font-weight:800">å­—é«”é‡ç½®</div>
              <div class="sub">æ¢å¾©é è¨­å¤§å°</div>
            </div>
            <div class="badge">A</div>
          </button>
        </div>
      </div>
    </aside>

    <!-- Center -->
    <main class="center">
      <div class="card">
        <div class="tabs" id="hotTabs"></div>

        <div class="composer">
          <div class="avatar"></div>
          <div class="composerMain">
            <div class="row" style="justify-content:space-between; gap:10px">
              <div class="muted" id="whoLine">å°šæœªç™»å…¥</div>
              <div class="row">
                <button class="btn good small" id="btnClaimAd">çœ‹å»£å‘Šæ‹¿ 100 GC</button>
                <button class="btn small" id="btnRefresh">åˆ·æ–°</button>
              </div>
            </div>

            <div style="height:10px"></div>

            <div class="row">
              <input class="input" id="qInput" placeholder="æœå°‹é¡Œç›®ï¼ˆä¾‹å¦‚ï¼šä¸–ç•Œç›ƒã€AIã€ç¸½çµ±...ï¼‰" />
            </div>

            <div style="height:10px"></div>

            <div class="grid3">
              <select class="select" id="tagSelect"></select>
              <input class="input" id="settleDateInput" placeholder="çµç®—æ—¥æœŸ (YYYY-MM-DD)" />
              <input class="input" id="coverUrlInput" placeholder="å°é¢åœ–ç‰‡ç¸®ç¶²å€ (æ­£æ–¹å½¢é è¦½)" />
            </div>

            <div style="height:10px"></div>

            <input class="input" id="titleInput" placeholder="ç™¼å¸ƒé æ¸¬é¡Œç›®ï¼ˆä¾‹å¦‚ï¼š2026 ä¸–è¶³å† è»æœƒæ˜¯èª°ï¼Ÿï¼‰" />

            <div style="height:10px"></div>

            <textarea class="textarea" id="optionsInput" placeholder="é¸é …ï¼ˆæ¯è¡Œä¸€å€‹ï¼Œ2~12 å€‹ï¼‰
ä¾‹ï¼š
é˜¿æ ¹å»·
æ³•åœ‹
å·´è¥¿
å¾·åœ‹"></textarea>

            <div style="height:10px"></div>

            <div class="row" style="justify-content:space-between">
              <div class="muted">å»ºç«‹é æ¸¬éœ€æ‰£ 1000 GCï¼ˆå¾Œç«¯åˆ¤æ–· Tier â‰¥ 4ï¼‰</div>
              <button class="btn brand" id="btnCreate">ç™¼å¸ƒé æ¸¬</button>
            </div>
          </div>
        </div>

        <div class="divider"></div>
        <div class="feed" id="feed"></div>
      </div>
    </main>

    <!-- Right -->
    <aside class="right">
      <div class="panel">
        <div class="sectionTitle">
          <h3>å¸³æˆ¶</h3>
          <span class="muted" id="rightStatus">æœªç™»å…¥</span>
        </div>
        <div style="padding:12px">
          <div class="kpi">
            <div class="box"><div class="v" id="kGC">â€”</div><div class="k">GC</div></div>
            <div class="box"><div class="v" id="kTier">â€”</div><div class="k">æœƒå“¡ç­‰ç´š</div></div>
            <div class="box"><div class="v" id="kWin">â€”</div><div class="k">å‹ç‡%</div></div>
          </div>

          <div style="height:10px"></div>
          <button class="btn" id="btnProfile" style="width:100%">å€‹äººæª”æ¡ˆ</button>
          <div style="height:8px"></div>
          <button class="btn" id="btnRules" style="width:100%">è¦å‰‡ & è¨­å®š</button>
          <div style="height:8px"></div>
          <button class="btn danger" id="btnLogout" style="width:100%">ç™»å‡º</button>
        </div>
      </div>

      <div style="height:12px"></div>

      <div class="panel">
        <div class="sectionTitle">
          <h3>æç¤º</h3>
        </div>
        <div style="padding:12px" class="muted">
          <div>â€¢ é æ¸¬æ˜¯å¹³å°å…§å¨›æ¨‚æ©Ÿåˆ¶ï¼ŒGC ä¸å¯å…Œç¾ã€‚</div>
          <div>â€¢ ç†±é–€æ’åºä¾æŠ•ç¥¨/äº’å‹•è¨ˆç®—ï¼ˆå¾Œç«¯ï¼‰ã€‚</div>
          <div>â€¢ é»è²¼æ–‡å¯çœ‹å®Œæ•´ç•™è¨€èˆ‡ç†±é–€ç•™è¨€ã€‚</div>
        </div>
      </div>
    </aside>
  </div>

  <!-- Auth Modal -->
  <div class="backdrop" id="authModal">
    <div class="modal">
      <div class="modalHeader">
        <div style="font-weight:900">ç™»å…¥ / è¨»å†Š</div>
        <div class="x" id="closeAuth">âœ•</div>
      </div>
      <div class="modalBody">
        <div class="twoCol">
          <div class="panel">
            <div class="sectionTitle"><h3>Email</h3><span class="muted">è¨»å†Š / ç™»å…¥</span></div>
            <div style="padding:12px">
              <div class="grid2">
                <input class="input" id="email" placeholder="Email" />
                <input class="input" id="password" placeholder="Password (>=6)" type="password" />
              </div>
              <div style="height:10px"></div>
              <div class="row">
                <button class="btn brand" id="btnRegister">è¨»å†Š</button>
                <button class="btn" id="btnLogin">ç™»å…¥</button>
                <span class="muted" id="authMsg"></span>
              </div>
              <div style="height:10px"></div>
              <div class="divider"></div>
              <div style="height:10px"></div>
              <div class="muted" style="font-size:.92em">
                ç™»å…¥æˆåŠŸå¾Œæœƒæ‹¿åˆ° tokenï¼ˆå­˜ localStorageï¼‰ï¼Œä¹‹å¾Œå‘¼å« API æœƒå¸¶ Bearer tokenã€‚
              </div>
            </div>
          </div>

          <div class="panel">
            <div class="sectionTitle"><h3>Google</h3><span class="muted">ä¸€éµç™»å…¥</span></div>
            <div style="padding:12px">
              <button class="googleBtn" id="btnGoogle">
                <span class="gIcon"></span>
                <span>Continue with Google</span>
              </button>
              <div style="height:10px"></div>
              <div class="muted" style="font-size:.92em">
                é€™å€‹æŒ‰éˆ•æœƒå°åˆ°ä½ çš„ Worker Google OAuth èµ·å§‹ç¶²å€ï¼ˆä½ å¾Œç«¯è¦æä¾› /api/auth/google/start ä¹‹é¡ï¼‰ã€‚
                <br/>å¦‚æœä½ ç›®å‰å¾Œç«¯é‚„æ²’åš Google OAuth è·¯ç”±ï¼ŒæŒ‰äº†æœƒæç¤ºå°šæœªå®Œæˆã€‚
              </div>
            </div>
          </div>
        </div>

        <div style="height:14px"></div>
        <div class="panel">
          <div class="sectionTitle"><h3>å°æé†’</h3></div>
          <div style="padding:12px" class="muted">
            è‹¥ä½ å·²å®Œæˆ Google OAuthï¼Œå›è·³æ™‚ä½ å¯ä»¥è®“å¾Œç«¯æŠŠ token æ”¾åœ¨ URL queryï¼ˆä¾‹å¦‚ ?token=xxxï¼‰ï¼Œå‰ç«¯æœƒè‡ªå‹•æŠ“å–ä¿å­˜ã€‚
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Post Detail Modal -->
  <div class="backdrop" id="detailModal">
    <div class="modal">
      <div class="modalHeader">
        <div style="font-weight:900">è²¼æ–‡è©³æƒ…</div>
        <div class="x" id="closeDetail">âœ•</div>
      </div>
      <div class="modalBody" id="detailBody"></div>
    </div>
  </div>

  <!-- Profile Modal -->
  <div class="backdrop" id="profileModal">
    <div class="modal">
      <div class="modalHeader">
        <div style="font-weight:900">å€‹äººæª”æ¡ˆ</div>
        <div class="x" id="closeProfile">âœ•</div>
      </div>
      <div class="modalBody">
        <div class="panel">
          <div class="sectionTitle"><h3>è³‡è¨Š</h3><span class="muted" id="profileEmail">â€”</span></div>
          <div style="padding:12px">
            <div class="grid2">
              <div>
                <div class="muted">æš±ç¨±</div>
                <input class="input" id="meNick" placeholder="æš±ç¨±ï¼ˆæœ€å¤š20å­—ï¼‰"/>
              </div>
              <div>
                <div class="muted">é æ¸¬å‹ç‡(%)</div>
                <input class="input" id="meWin" placeholder="0~100"/>
              </div>
            </div>
            <div style="height:10px"></div>
            <div class="grid2">
              <div>
                <div class="muted">ç­‰ç´š(Level)</div>
                <input class="input" id="meLevel" placeholder="1~999"/>
              </div>
              <div>
                <div class="muted">æœƒå“¡ç­‰ç´š(Tier)</div>
                <input class="input" id="meTier" placeholder="1~10"/>
              </div>
            </div>
            <div style="height:10px"></div>
            <div>
              <div class="muted">å€‹äººç°½å</div>
              <textarea class="textarea" id="meBio" placeholder="æœ€å¤š140å­—"></textarea>
            </div>
            <div style="height:10px"></div>
            <div class="panel" style="padding:12px; background:rgba(255,255,255,.02)">
              <div class="row" style="justify-content:space-between">
                <div>
                  <div style="font-weight:900">å­—é«”å¤§å°</div>
                  <div class="muted" style="font-size:.92em">åªå½±éŸ¿æœ¬æ©Ÿé¡¯ç¤ºï¼ˆlocalStorageï¼‰</div>
                </div>
                <div class="row">
                  <button class="btn small" id="fontMinus">A-</button>
                  <button class="btn small" id="fontPlus">A+</button>
                </div>
              </div>
            </div>

            <div style="height:10px"></div>
            <div class="row">
              <button class="btn brand" id="btnSaveMe">å„²å­˜</button>
              <span class="muted" id="profileMsg"></span>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Rules & Settings Modal -->
  <div class="backdrop" id="rulesModal">
    <div class="modal">
      <div class="modalHeader">
        <div style="font-weight:900">è¦å‰‡ & è¨­å®š</div>
        <div class="x" id="closeRules">âœ•</div>
      </div>
      <div class="modalBody">
        <div class="panel">
          <div class="sectionTitle">
            <h3>çµ¦ä½¿ç”¨è€…çœ‹çš„ä½¿ç”¨é¢¨éšª</h3>
            <span class="muted">è«‹å‹™å¿…é–±è®€</span>
          </div>
          <div style="padding:12px" class="muted">
            <div style="margin-bottom:8px">
              1) æœ¬å¹³å°ä¹‹é æ¸¬ã€æŠ•ç¥¨èˆ‡äº’å‹•å±¬æ–¼<strong>å¨›æ¨‚/ç¤¾ç¾¤</strong>ç”¨é€”ï¼ŒGC ç‚ºå¹³å°å…§éƒ¨é»æ•¸ï¼Œ<strong>ä¸å¯å…Œç¾</strong>ã€ä¸å¯è¦æ±‚å¹³å°æˆ–ä»»ä½•äººè¿”é‚„ç­‰å€¼è²¡ç”¢ã€‚
            </div>
            <div style="margin-bottom:8px">
              2) é æ¸¬çµæœã€ç†±é–€æ’åºã€ç•™è¨€å…§å®¹ç”±ä½¿ç”¨è€…ç”¢ç”Ÿï¼Œå¹³å°ä¸ä¿è­‰å…¶æ­£ç¢ºæ€§èˆ‡å®Œæ•´æ€§ã€‚
            </div>
            <div style="margin-bottom:8px">
              3) ä½ å¿…é ˆè‡ªè¡Œè©•ä¼°ä½¿ç”¨æœ¬å¹³å°çš„æ™‚é–“æˆæœ¬èˆ‡è³‡è¨Šé¢¨éšªï¼›å¹³å°ä¸æä¾›æŠ•è³‡ã€ç†è²¡æˆ–æ³•å¾‹å»ºè­°ã€‚
            </div>
            <div>
              4) å¹³å°å¯ä¾è¦å‰‡é€²è¡Œç®¡ç†ï¼ˆä¾‹å¦‚ï¼šåˆªé™¤é•è¦å…§å®¹ã€é™åˆ¶åƒèˆ‡ï¼‰ï¼Œä¸¦å¯èƒ½èª¿æ•´åƒæ•¸ï¼ˆå†·å»æ™‚é–“ã€è²»ç”¨ç­‰ï¼‰ã€‚
            </div>
          </div>
        </div>

        <div style="height:14px"></div>

        <div class="panel">
          <div class="sectionTitle"><h3>è¨­å®š</h3><span class="muted">UI</span></div>
          <div style="padding:12px">
            <div class="row">
              <button class="btn" id="btnLight2">é–‹ç‡ˆ / é—œç‡ˆ</button>
              <button class="btn" id="btnFontReset2">å­—é«”é‡ç½®</button>
            </div>
          </div>
        </div>

        <div style="height:14px"></div>

        <div class="panel">
          <div class="sectionTitle"><h3>è¦å‰‡æ‘˜è¦</h3><span class="muted">demo</span></div>
          <div style="padding:12px" class="muted">
            <div>â€¢ çœ‹å»£å‘Šæ¯ 12 å°æ™‚å¯é ˜ 100 GCï¼ˆå¾Œç«¯åˆ¤æ–·å†·å»ï¼‰ã€‚</div>
            <div>â€¢ Tier â‰¥ 4 å¯å»ºç«‹é æ¸¬ï¼Œå»ºç«‹è²» 1000 GCï¼ˆå¾Œç«¯åˆ¤æ–·ï¼‰ã€‚</div>
            <div>â€¢ æŠ•ç¥¨æŠ•æ³¨æœ€å°‘ 100 GCï¼ˆç›®å‰å¾Œç«¯æŠ•ç¥¨æ˜¯ã€Œ1ç¥¨ã€ç¤ºç¯„ï¼Œä½ ä¹‹å¾Œå¯æŠŠæŠ•æ³¨é¡èˆ‡é…åˆ†åŠ å›å»ï¼‰ã€‚</div>
          </div>
        </div>
      </div>
    </div>
  </div>

<script>
/** =========================
 *  CONFIG
 *  ========================= */
const API_BASE = "https://api.feex.win"; // ä½ çš„ Worker API
const TAGS = [
  { id:"all", name:"å…¨éƒ¨" },
  { id:"sports", name:"é‹å‹•" },
  { id:"current", name:"æ™‚å‹¢" },
  { id:"politics", name:"æ”¿æ²»" },
  { id:"tech", name:"ç§‘æŠ€" },
  { id:"finance", name:"é‡‘è" },
  { id:"ent", name:"å¨›æ¨‚" },
];

const NAV = [
  { id:"home", name:"é¦–é ", sub:"ç†±é–€é æ¸¬" },
  { id:"profile", name:"å€‹äººæª”æ¡ˆ", sub:"æš±ç¨±/ç°½å/å­—é«”" },
  { id:"rules", name:"è¦å‰‡&è¨­å®š", sub:"é¢¨éšªèˆ‡UI" },
];

const HOTS = [
  { id:"day", name:"ç•¶æ—¥ç†±é–€" },
  { id:"week", name:"æœ¬é€±ç†±é–€" },
  { id:"month", name:"æœ¬æœˆç†±é–€" },
  { id:"all", name:"ç¸½ç†±é–€" },
];

/** =========================
 *  STATE
 *  ========================= */
let state = {
  hot:"day",
  tag:"all",
  q:"",
  token: localStorage.getItem("feex_token") || "",
  me: null,
  theme: localStorage.getItem("feex_theme") || "dark",
  fontScale: Number(localStorage.getItem("feex_fontScale") || "1"),
  predictions: [],
};

document.documentElement.style.setProperty("--fontScale", String(state.fontScale));

/** =========================
 *  UTIL
 *  ========================= */
const $ = (id)=>document.getElementById(id);
const esc = (s)=>String(s ?? "").replace(/[&<>"']/g, m=>({ "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;" }[m]));
const fmtDate = (msOrIso)=>{
  if(!msOrIso) return "";
  if(typeof msOrIso === "string" && /^\d{4}-\d{2}-\d{2}$/.test(msOrIso)) return msOrIso;
  const d = new Date(Number(msOrIso));
  if (isNaN(d.getTime())) return String(msOrIso);
  return d.toISOString().slice(0,10);
};
function toast(msg){
  alert(msg);
}
async function api(path, opts={}){
  const headers = Object.assign({ "Content-Type":"application/json" }, opts.headers||{});
  if(state.token) headers["Authorization"] = "Bearer " + state.token;
  const res = await fetch(API_BASE + path, { ...opts, headers });
  const data = await res.json().catch(()=>({ ok:false, error:"Bad JSON" }));
  if(!res.ok && !data.ok && data.error === "Unauthorized"){
    // auto logout
    state.token = "";
    localStorage.removeItem("feex_token");
    state.me = null;
    renderMe();
  }
  return data;
}

/** =========================
 *  UI init
 *  ========================= */
function buildHotTabs(){
  const el = $("hotTabs");
  el.innerHTML = HOTS.map(h=>(
    `<span class="pill ${state.hot===h.id?'active':''}" data-hot="${h.id}">${esc(h.name)}</span>`
  )).join("");
  el.onclick = (e)=>{
    const t = e.target.closest("[data-hot]");
    if(!t) return;
    state.hot = t.dataset.hot;
    buildHotTabs();
    loadFeed();
  };
}
function buildTags(){
  const tagNav = $("tagNav");
  const mobileTags = $("mobileTags");
  const tagSelect = $("tagSelect");
  tagSelect.innerHTML = TAGS.filter(x=>x.id!=="all").map(t=>`<option value="${t.id}">${esc(t.name)}</option>`).join("");

  const tagBtns = TAGS.map(t=>{
    const active = state.tag===t.id;
    return `<button class="navItem ${active?'active':''}" data-tag="${t.id}">
      <div style="font-weight:800">${esc(t.name)}</div>
      <div class="badge">${active?'ON':''}</div>
    </button>`;
  }).join("");

  tagNav.innerHTML = tagBtns;
  mobileTags.innerHTML = tagBtns;

  const onClick = (e)=>{
    const b = e.target.closest("[data-tag]");
    if(!b) return;
    state.tag = b.dataset.tag;
    buildTags();
    loadFeed();
    closeDrawer();
  };
  tagNav.onclick = onClick;
  mobileTags.onclick = onClick;
}
function buildNav(){
  const leftNav = $("leftNav");
  const mobileNav = $("mobileNav");
  const html = NAV.map(n=>`
    <button class="navItem" data-nav="${n.id}">
      <div>
        <div style="font-weight:900">${esc(n.name)}</div>
        <div class="sub">${esc(n.sub)}</div>
      </div>
      <div class="badge">â†’</div>
    </button>
  `).join("");
  leftNav.innerHTML = html;
  mobileNav.innerHTML = html;

  const onClick = (e)=>{
    const b = e.target.closest("[data-nav]");
    if(!b) return;
    const id = b.dataset.nav;
    if(id==="profile") openProfile();
    if(id==="rules") openRules();
    if(id==="home") window.scrollTo({ top:0, behavior:"smooth" });
    closeDrawer();
  };
  leftNav.onclick = onClick;
  mobileNav.onclick = onClick;
}

/** Drawer */
function openDrawer(){ $("drawer").classList.add("show"); }
function closeDrawer(){ $("drawer").classList.remove("show"); }

/** Modals */
function showModal(id){ $(id).classList.add("show"); }
function hideModal(id){ $(id).classList.remove("show"); }

/** =========================
 *  Auth (Email)
 *  ========================= */
async function doRegister(){
  $("authMsg").textContent = "è™•ç†ä¸­â€¦";
  const email = $("email").value.trim();
  const password = $("password").value;
  const r = await api("/api/register", { method:"POST", body: JSON.stringify({ email, password })});
  if(!r.ok){
    $("authMsg").textContent = r.error || "è¨»å†Šå¤±æ•—";
    return;
  }
  $("authMsg").textContent = "è¨»å†ŠæˆåŠŸï¼Œè«‹ç™»å…¥";
}
async function doLogin(){
  $("authMsg").textContent = "è™•ç†ä¸­â€¦";
  const email = $("email").value.trim();
  const password = $("password").value;
  const r = await api("/api/login", { method:"POST", body: JSON.stringify({ email, password })});
  if(!r.ok){
    $("authMsg").textContent = r.error || "ç™»å…¥å¤±æ•—";
    return;
  }
  state.token = r.token;
  localStorage.setItem("feex_token", state.token);
  $("authMsg").textContent = "ç™»å…¥æˆåŠŸ";
  await loadMe();
  hideModal("authModal");
  loadFeed();
}

/** Google button (placeholder route) */
function goGoogle(){
  // ä½ å¾Œç«¯è‹¥æœ‰ Google OAuthï¼Œå»ºè­°æä¾›ä¸€å€‹ start endpointï¼Œå›è·³å¾Œå¸¶ ?token=xxx
  // ä¾‹å¦‚ï¼š/api/auth/google/start
  const url = API_BASE + "/api/auth/google/start";
  // å…ˆæ¢æ¸¬ä¸€ä¸‹è·¯ç”±å­˜ä¸å­˜åœ¨
  fetch(url, { method:"GET" }).then(r=>{
    if(r.status === 404) throw new Error("not ready");
    window.location.href = url;
  }).catch(()=>{
    toast("Google OAuth å¾Œç«¯è·¯ç”±å°šæœªå®Œæˆï¼ˆéœ€è¦ /api/auth/google/startï¼‰");
  });
}

/** =========================
 *  Me / Profile
 *  ========================= */
async function loadMe(){
  if(!state.token) { state.me=null; renderMe(); return; }
  const r = await api("/api/me", { method:"GET" });
  if(!r.ok){ state.me=null; renderMe(); return; }
  state.me = r.user;
  renderMe();
}
function renderMe(){
  const who = state.me ? `å·²ç™»å…¥ï¼š${state.me.nick}ï¼ˆGC ${state.me.gc}ï¼‰` : "å°šæœªç™»å…¥";
  $("whoLine").textContent = who;
  $("rightStatus").textContent = state.me ? state.me.email : "æœªç™»å…¥";
  $("kGC").textContent = state.me ? String(state.me.gc) : "â€”";
  $("kTier").textContent = state.me ? String(state.me.tier) : "â€”";
  $("kWin").textContent = state.me ? String(state.me.winRate ?? state.me.win_rate ?? "â€”") : "â€”";
  $("btnLogout").style.display = state.me ? "block" : "none";
}

function openProfile(){
  if(!state.me) { showModal("authModal"); return; }
  $("profileEmail").textContent = state.me.email;
  $("meNick").value = state.me.nick || "";
  $("meBio").value = state.me.bio || "";
  $("meTier").value = state.me.tier ?? "";
  $("meLevel").value = state.me.level ?? "";
  $("meWin").value = state.me.winRate ?? state.me.win_rate ?? "";
  $("profileMsg").textContent = "";
  showModal("profileModal");
}
async function saveProfile(){
  if(!state.me) return;
  $("profileMsg").textContent = "å„²å­˜ä¸­â€¦";
  const body = {
    nick: $("meNick").value.trim(),
    bio: $("meBio").value.trim(),
    tier: $("meTier").value.trim(),
    level: $("meLevel").value.trim(),
    winRate: $("meWin").value.trim(),
  };
  const r = await api("/api/me", { method:"PATCH", body: JSON.stringify(body) });
  if(!r.ok){ $("profileMsg").textContent = r.error || "å„²å­˜å¤±æ•—"; return; }
  state.me = r.user;
  $("profileMsg").textContent = "å·²å„²å­˜";
  renderMe();
}

function openRules(){ showModal("rulesModal"); }

/** =========================
 *  Feed
 *  ========================= */
function truncateText(s, max=70){
  const t = String(s||"");
  if(t.length<=max) return { short:t, cut:false };
  return { short:t.slice(0,max) + "â€¦", cut:true };
}

async function loadFeed(){
  const q = state.q;
  const qs = new URLSearchParams();
  qs.set("hot", state.hot);
  qs.set("tag", state.tag);
  if(q) qs.set("q", q);
  const r = await api("/api/predictions?" + qs.toString(), { method:"GET" });
  if(!r.ok){
    $("feed").innerHTML = `<div style="padding:14px" class="muted">è¼‰å…¥å¤±æ•—ï¼š${esc(r.error||"")}</div>`;
    return;
  }
  state.predictions = r.predictions || [];
  renderFeed();
}

function renderFeed(){
  const feed = $("feed");
  if(!state.predictions.length){
    feed.innerHTML = `<div style="padding:14px" class="muted">ç›®å‰æ²’æœ‰è³‡æ–™</div>`;
    return;
  }
  feed.innerHTML = state.predictions.map(p=>{
    const owner = p.ownerNick || p.owner_nick || p.owner || "â€”"; // å¾Œç«¯å¦‚æœæ²’å›æœƒé¡¯ç¤º â€”
    const top2 = Array.isArray(p.topComments) ? p.topComments : [];
    const top2Html = top2.map(c=>{
      const tr = truncateText(c.text, 70);
      return `
        <div class="tweetPreview" data-stop="1">
          <div class="who">${esc(c.author || "User")} <span class="muted">Â· â¤ ${Number(c.likes||0)}</span></div>
          <div class="txt" data-full="${esc(c.text)}" data-cut="${tr.cut ? '1':'0'}">${esc(tr.short)}</div>
          ${tr.cut ? `<span class="moreBtn" data-more="1">é¡¯ç¤ºæ›´å¤š</span>` : ``}
        </div>
      `;
    }).join("");

    return `
      <div class="post" data-id="${esc(p.id)}">
        <div class="avatar"></div>
        <div class="postMain">
          <div class="postHead">
            <div class="postMeta">
              <span style="font-weight:900">${esc(owner)}</span>
              <span class="muted">Â·</span>
              <span class="muted">${esc(fmtDate(p.createdAt))}</span>
              <span class="badge">${esc(tagName(p.tag))}</span>
              <span class="badge">çµç®— ${esc(fmtDate(p.settleDate))}</span>
            </div>
            <div class="muted" style="font-size:.92em">â¤ ${Number(p.likes||0)} Â· ğŸ’¬ ${Number(p.commentsCount||0)}</div>
          </div>

          <div class="title">${esc(p.title)}</div>

          ${p.coverUrl ? `<div class="cover"><img src="${esc(p.coverUrl)}" alt="cover" loading="lazy"/></div>` : ""}

          <div class="actions" data-stop="1">
            <span class="chip primary" data-open="1">æŸ¥çœ‹</span>
            <span class="chip ${Number(p.likes||0)>0?'':'']}" data-likepred="${esc(p.id)}">â¤ ${Number(p.likes||0)}</span>
          </div>

          ${top2.length ? `<div class="top2" data-stop="1">${top2Html}</div>` : ""}
        </div>
      </div>
    `;
  }).join("");

  feed.onclick = async (e)=>{
    // prevent bubbling for buttons
    if(e.target.closest("[data-stop]")){
      // "é¡¯ç¤ºæ›´å¤š"
      const more = e.target.closest("[data-more]");
      if(more){
        const box = more.closest(".tweetPreview");
        const txt = box.querySelector(".txt");
        txt.textContent = txt.dataset.full;
        more.remove();
        return;
      }
      // like preview post
      const like = e.target.closest("[data-likepred]");
      if(like){
        if(!state.me){ showModal("authModal"); return; }
        const id = like.dataset.likepred;
        const r = await api(`/api/predictions/${encodeURIComponent(id)}/like`, { method:"POST" });
        if(!r.ok){ toast(r.error||"å¤±æ•—"); return; }
        loadFeed();
        return;
      }
      // open detail
      const open = e.target.closest("[data-open]");
      if(open){
        const post = e.target.closest(".post");
        if(post) openDetail(post.dataset.id);
        return;
      }
    }
    // open detail when click post
    const post = e.target.closest(".post");
    if(post) openDetail(post.dataset.id);
  };
}

function tagName(id){
  const t = TAGS.find(x=>x.id===id);
  return t ? t.name : id;
}

/** =========================
 *  Create prediction
 *  ========================= */
async function createPrediction(){
  if(!state.me){ showModal("authModal"); return; }
  const title = $("titleInput").value.trim();
  const tag = $("tagSelect").value;
  const settleDate = $("settleDateInput").value.trim();
  const coverUrl = $("coverUrlInput").value.trim();
  const options = $("optionsInput").value.split("\n").map(s=>s.trim()).filter(Boolean);

  const r = await api("/api/predictions", {
    method:"POST",
    body: JSON.stringify({ title, tag, settleDate, coverUrl, options })
  });
  if(!r.ok){
    toast(r.error || "ç™¼å¸ƒå¤±æ•—");
    return;
  }
  toast("ç™¼å¸ƒæˆåŠŸ");
  $("titleInput").value = "";
  $("optionsInput").value = "";
  $("coverUrlInput").value = "";
  loadMe();
  loadFeed();
}

/** =========================
 *  Detail view
 *  ========================= */
async function openDetail(predId){
  const r = await api(`/api/predictions/${encodeURIComponent(predId)}`, { method:"GET" });
  if(!r.ok){ toast(r.error || "è¼‰å…¥å¤±æ•—"); return; }
  const p = r.prediction;

  const opts = (p.options||[]).map(o=>{
    const pct = p.totalVotes ? Math.round((o.votes / p.totalVotes)*100) : 0;
    const mine = (p.myVote && p.myVote===o.id);
    return `
      <div class="panel" style="padding:12px; background:rgba(255,255,255,.02); border-radius:14px; cursor:pointer"
           data-option="${esc(o.id)}" data-pred="${esc(p.id)}">
        <div style="display:flex; justify-content:space-between; gap:10px">
          <div style="font-weight:900">${esc(o.text)}</div>
          <div class="muted">${Number(o.votes)}ç¥¨ Â· ${pct}% ${mine? "Â· ä½ å·²é¸": ""}</div>
        </div>
        <div style="height:8px"></div>
        <div style="height:8px; border-radius:999px; background:rgba(255,255,255,.06); overflow:hidden">
          <div style="height:100%; width:${pct}%; background:rgba(29,155,240,.65)"></div>
        </div>
      </div>
    `;
  }).join("");

  const comments = (p.comments||[]);
  const hotComments = [...comments].sort((a,b)=>(b.likes||0)-(a.likes||0)).slice(0,20);

  const commentHtml = (list)=> list.map(c=>{
    const tr = truncateText(c.text, 140);
    return `
      <div class="panel" style="padding:12px; border-radius:14px; background:rgba(255,255,255,.02)">
        <div style="display:flex; justify-content:space-between; gap:10px; align-items:center">
          <div><span style="font-weight:900">${esc(c.author||"User")}</span> <span class="muted">Â· ${esc(fmtDate(c.createdAt))}</span></div>
          <div class="row">
            <button class="btn small ${Number(c.likes||0)>0?'':'']}" data-likec="${esc(c.id)}">â¤ ${Number(c.likes||0)}</button>
          </div>
        </div>
        <div style="margin-top:8px" class="txt" data-full="${esc(c.text)}">${esc(tr.short)}</div>
        ${tr.cut ? `<span class="moreBtn" data-more="1">é¡¯ç¤ºæ›´å¤š</span>` : ``}
      </div>
    `;
  }).join("");

  $("detailBody").innerHTML = `
    <div class="panel">
      <div class="sectionTitle">
        <div>
          <div style="font-weight:900">${esc(p.title)}</div>
          <div class="muted" style="font-size:.92em">TAGï¼š${esc(tagName(p.tag))} Â· çµç®—ï¼š${esc(fmtDate(p.settleDate))}</div>
        </div>
        <div class="row">
          <button class="btn small ${p.likedByMe?'danger':''}" id="btnLikePredInDetail">â¤ ${Number(p.likes||0)}</button>
        </div>
      </div>
      <div style="padding:12px">
        ${p.coverUrl ? `<div class="cover"><img src="${esc(p.coverUrl)}" alt="cover"/></div>` : ""}
        <div style="height:12px"></div>
        <div class="muted">ç¸½ç¥¨æ•¸ï¼š${Number(p.totalVotes||0)}</div>
        <div style="height:10px"></div>
        <div class="panel" style="padding:12px; border-radius:14px; background:rgba(255,255,255,.02)">
          <div style="font-weight:900; margin-bottom:8px">æŠ•ç¥¨</div>
          <div style="display:flex; flex-direction:column; gap:10px" id="optList">${opts}</div>
          <div class="muted" style="margin-top:8px; font-size:.92em">ï¼ˆç›®å‰ demo æ˜¯ 1 æ¬¡æŠ•ç¥¨ +1 ç¥¨ï¼Œä¹‹å¾Œä½ è¦åŠ ã€ŒæŠ•æ³¨ GCã€å†æŠŠ vote API æ“´å……ã€‚ï¼‰</div>
        </div>

        <div style="height:12px"></div>

        <div class="panel" style="padding:12px; border-radius:14px; background:rgba(255,255,255,.02)">
          <div style="font-weight:900; margin-bottom:8px">ç•™è¨€</div>
          <div class="row">
            <input class="input" id="commentText" placeholder="å¯«ä¸‹ä½ çš„ç•™è¨€ï¼ˆæœ€å¤š300å­—ï¼‰" />
            <button class="btn brand" id="btnSendComment">é€å‡º</button>
          </div>
          <div class="muted" style="margin-top:8px; font-size:.92em">é» â¤ å¯æŒ‰è®šç•™è¨€ï¼ˆå¯åˆ‡æ›ï¼‰ã€‚</div>
        </div>

        <div style="height:12px"></div>

        <div class="panel">
          <div class="sectionTitle">
            <h3>ç•™è¨€æª¢è¦–</h3>
            <div class="row">
              <span class="pill active" id="tabAll">å…¨éƒ¨ç•™è¨€</span>
              <span class="pill" id="tabHot">ç†±é–€ç•™è¨€</span>
            </div>
          </div>
          <div style="padding:12px; display:flex; flex-direction:column; gap:10px" id="commentList">
            ${commentHtml(comments)}
          </div>
        </div>
      </div>
    </div>
  `;

  // like prediction
  $("btnLikePredInDetail").onclick = async ()=>{
    if(!state.me){ showModal("authModal"); return; }
    const rr = await api(`/api/predictions/${encodeURIComponent(p.id)}/like`, { method:"POST" });
    if(!rr.ok){ toast(rr.error||"å¤±æ•—"); return; }
    openDetail(p.id); // refresh
    loadFeed();
  };

  // vote
  $("optList").onclick = async (e)=>{
    const card = e.target.closest("[data-option]");
    if(!card) return;
    if(!state.me){ showModal("authModal"); return; }
    const optionId = card.dataset.option;
    const pred = card.dataset.pred;
    const rr = await api(`/api/predictions/${encodeURIComponent(pred)}/vote`, {
      method:"POST",
      body: JSON.stringify({ optionId })
    });
    if(!rr.ok){ toast(rr.error||"æŠ•ç¥¨å¤±æ•—"); return; }
    toast("æŠ•ç¥¨æˆåŠŸ");
    openDetail(pred);
    loadFeed();
  };

  // send comment
  $("btnSendComment").onclick = async ()=>{
    if(!state.me){ showModal("authModal"); return; }
    const text = $("commentText").value.trim();
    if(!text) return;
    const rr = await api(`/api/predictions/${encodeURIComponent(p.id)}/comments`, {
      method:"POST",
      body: JSON.stringify({ text })
    });
    if(!rr.ok){ toast(rr.error||"ç•™è¨€å¤±æ•—"); return; }
    $("commentText").value = "";
    openDetail(p.id);
    loadFeed();
  };

  // like comment + expand
  const commentList = $("commentList");
  commentList.onclick = async (e)=>{
    const more = e.target.closest("[data-more]");
    if(more){
      const box = more.parentElement;
      const txt = box.querySelector(".txt");
      txt.textContent = txt.dataset.full;
      more.remove();
      return;
    }
    const like = e.target.closest("[data-likec]");
    if(like){
      if(!state.me){ showModal("authModal"); return; }
      const id = like.dataset.likec;
      const rr = await api(`/api/comments/${encodeURIComponent(id)}/like`, { method:"POST" });
      if(!rr.ok){ toast(rr.error||"å¤±æ•—"); return; }
      openDetail(p.id);
      loadFeed();
      return;
    }
  };

  // tabs
  $("tabAll").onclick = ()=>{
    $("tabAll").classList.add("active"); $("tabHot").classList.remove("active");
    commentList.innerHTML = commentHtml(comments);
  };
  $("tabHot").onclick = ()=>{
    $("tabHot").classList.add("active"); $("tabAll").classList.remove("active");
    commentList.innerHTML = commentHtml(hotComments);
  };

  showModal("detailModal");
}

/** =========================
 *  Ad claim
 *  ========================= */
async function claimAd(){
  if(!state.me){ showModal("authModal"); return; }
  const r = await api("/api/claim-ad", { method:"POST" });
  if(!r.ok){
    if(r.error === "Cooldown"){
      const mins = Math.ceil((r.remainingMs||0)/60000);
      toast(`å†·å»ä¸­ï¼Œç´„ ${mins} åˆ†é˜å¾Œå¯å†é ˜`);
      return;
    }
    toast(r.error || "å¤±æ•—");
    return;
  }
  toast(`å·²é ˜å– ${r.reward} GCï¼Œç›®å‰é¤˜é¡ï¼š${r.newBalance}`);
  await loadMe();
}

/** =========================
 *  Theme + font
 *  ========================= */
function applyTheme(){
  // demoï¼šåªåšç°¡å–®æ˜æš—åˆ‡æ›ï¼ˆäº®æ¨¡å¼ä»ç¶­æŒæ·±è‰²åŸºåº•ï¼Œä½†æé«˜å°æ¯”ï¼‰
  const light = (state.theme === "light");
  document.body.style.background = light ? "#070707" : "#000";
}
function toggleTheme(){
  state.theme = (state.theme === "light") ? "dark" : "light";
  localStorage.setItem("feex_theme", state.theme);
  applyTheme();
}
function fontPlus(){
  state.fontScale = Math.min(1.35, +(state.fontScale + 0.05).toFixed(2));
  localStorage.setItem("feex_fontScale", String(state.fontScale));
  document.documentElement.style.setProperty("--fontScale", String(state.fontScale));
}
function fontMinus(){
  state.fontScale = Math.max(0.85, +(state.fontScale - 0.05).toFixed(2));
  localStorage.setItem("feex_fontScale", String(state.fontScale));
  document.documentElement.style.setProperty("--fontScale", String(state.fontScale));
}
function fontReset(){
  state.fontScale = 1;
  localStorage.setItem("feex_fontScale", "1");
  document.documentElement.style.setProperty("--fontScale", "1");
}

/** =========================
 *  Wire up
 *  ========================= */
function init(){
  applyTheme();
  buildHotTabs();
  buildNav();
  buildTags();

  // token in URL (Google OAuth callback pattern: ?token=xxx)
  const u = new URL(location.href);
  const t = u.searchParams.get("token");
  if(t){
    state.token = t;
    localStorage.setItem("feex_token", t);
    u.searchParams.delete("token");
    history.replaceState({}, "", u.toString());
  }

  $("btnOpenDrawer").onclick = openDrawer;
  $("drawerShade").onclick = closeDrawer;
  $("btnCloseDrawer").onclick = closeDrawer;

  $("btnOpenAuth").onclick = ()=>showModal("authModal");
  $("btnAuthLeft").onclick = ()=>showModal("authModal");

  $("closeAuth").onclick = ()=>hideModal("authModal");
  $("closeDetail").onclick = ()=>hideModal("detailModal");
  $("closeProfile").onclick = ()=>hideModal("profileModal");
  $("closeRules").onclick = ()=>hideModal("rulesModal");

  $("btnRegister").onclick = doRegister;
  $("btnLogin").onclick = doLogin;
  $("btnGoogle").onclick = goGoogle;

  $("btnRefresh").onclick = loadFeed;
  $("qInput").oninput = ()=>{
    state.q = $("qInput").value.trim();
    // debounce
    clearTimeout(window.__qT);
    window.__qT = setTimeout(loadFeed, 250);
  };

  $("btnCreate").onclick = createPrediction;

  $("btnClaimAd").onclick = claimAd;

  $("btnProfile").onclick = openProfile;
  $("btnRules").onclick = openRules;
  $("btnLogout").onclick = ()=>{
    state.token = "";
    localStorage.removeItem("feex_token");
    state.me = null;
    renderMe();
    toast("å·²ç™»å‡º");
  };

  $("btnLight").onclick = toggleTheme;
  $("btnLight2").onclick = toggleTheme;

  $("btnFontReset").onclick = fontReset;
  $("btnFontReset2").onclick = fontReset;

  $("fontPlus").onclick = fontPlus;
  $("fontMinus").onclick = fontMinus;

  $("btnSaveMe").onclick = saveProfile;

  // close modal by clicking backdrop
  ["authModal","detailModal","profileModal","rulesModal"].forEach(id=>{
    $(id).addEventListener("click",(e)=>{ if(e.target === $(id)) hideModal(id); });
  });

  loadMe().then(loadFeed);
}
init();
</script>
</body>
</html>
