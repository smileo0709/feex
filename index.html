<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>FEEx â€” Future Event Exchange</title>
  <style>
    :root{
      --bg:#000; --panel:#0b0b0b; --panel2:#111; --text:#e7e7e7; --muted:#9aa0a6;
      --line:#222; --blue:#1d9bf0; --red:#ff4d4f; --green:#21c55d; --chip:#16181c;
      --shadow: 0 10px 30px rgba(0,0,0,.35);
      --radius: 16px;
      --w: 1100px;
    }
    *{box-sizing:border-box}
    body{margin:0;background:var(--bg);color:var(--text);font-family: ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,"Noto Sans TC","PingFang TC","Microsoft JhengHei",Arial}
    a{color:inherit}
    button,input,select,textarea{font:inherit}
    .app{min-height:100vh;display:flex;justify-content:center}
    .wrap{width:100%;max-width:var(--w);display:grid;grid-template-columns: 280px 1fr 340px;gap:14px;padding:14px}
    .card{background:var(--panel);border:1px solid var(--line);border-radius:var(--radius);box-shadow:var(--shadow)}
    .left,.mid,.right{min-height:40px}
    .left .card,.right .card{position:sticky;top:14px}
    .nav{padding:12px}
    .brand{display:flex;align-items:center;gap:10px;padding:10px 10px 14px}
    .logo{width:34px;height:34px;border-radius:10px;background:linear-gradient(135deg,#1d9bf0,#7c3aed)}
    .brand b{font-size:18px}
    .nav a,.nav button{display:flex;gap:10px;align-items:center;width:100%;padding:10px 12px;border-radius:12px;text-decoration:none;border:0;background:transparent;color:var(--text);cursor:pointer}
    .nav a:hover,.nav button:hover{background:var(--panel2)}
    .pill{display:inline-flex;align-items:center;gap:8px;padding:6px 10px;border-radius:999px;background:var(--chip);border:1px solid var(--line);color:var(--muted);font-size:12px}
    .muted{color:var(--muted)}
    .danger{color:var(--red)}
    .ok{color:var(--green)}
    .btn{border:1px solid var(--line);background:var(--panel2);color:var(--text);padding:10px 12px;border-radius:12px;cursor:pointer}
    .btn:hover{border-color:#333}
    .btn.primary{background:var(--blue);border-color:transparent;color:#000;font-weight:700}
    .btn.primary:hover{filter:brightness(1.03)}
    .btn.ghost{background:transparent}
    .btn.small{padding:7px 10px;border-radius:10px;font-size:13px}
    .input{width:100%;padding:10px 12px;border-radius:12px;border:1px solid var(--line);background:#000;color:var(--text)}
    .row{display:flex;gap:10px;align-items:center}
    .col{display:flex;flex-direction:column;gap:10px}
    .sep{height:1px;background:var(--line);margin:10px 0}
    .tabs{display:flex;gap:8px;flex-wrap:wrap}
    .tab{padding:8px 10px;border-radius:999px;border:1px solid var(--line);background:transparent;color:var(--text);cursor:pointer}
    .tab.active{background:var(--chip)}
    .midHeader{padding:12px 14px;border-bottom:1px solid var(--line);display:flex;justify-content:space-between;align-items:center}
    .midHeader h1{margin:0;font-size:18px}
    .subtabs{display:flex;gap:8px;flex-wrap:wrap}
    .feed{padding:0}
    .post{padding:14px;border-bottom:1px solid var(--line);display:grid;grid-template-columns:44px 1fr;gap:10px}
    .avatar{width:44px;height:44px;border-radius:999px;background:#222}
    .postTop{display:flex;justify-content:space-between;gap:10px}
    .nick{font-weight:800}
    .meta{color:var(--muted);font-size:12px}
    .title{margin:6px 0 8px;font-size:15px;line-height:1.35}
    .cover{width:100%;aspect-ratio:1/1;max-height:360px;border-radius:16px;border:1px solid var(--line);background:#050505;display:flex;align-items:center;justify-content:center;overflow:hidden}
    .cover img{width:100%;height:100%;object-fit:cover;display:block}
    .actions{display:flex;gap:14px;align-items:center;margin-top:10px;color:var(--muted);font-size:13px}
    .actionBtn{border:0;background:transparent;color:inherit;cursor:pointer;padding:6px 8px;border-radius:10px}
    .actionBtn:hover{background:var(--panel2)}
    .twolines{display:-webkit-box;-webkit-line-clamp:2;-webkit-box-orient:vertical;overflow:hidden}
    .more{color:var(--blue);cursor:pointer}
    .rightBox{padding:12px}
    .rightBox h3{margin:0 0 10px;font-size:14px}
    .tagGrid{display:flex;gap:8px;flex-wrap:wrap}
    .tag{padding:8px 10px;border-radius:999px;border:1px solid var(--line);background:transparent;cursor:pointer}
    .tag.active{background:var(--chip)}
    .modalBackdrop{position:fixed;inset:0;background:rgba(0,0,0,.55);display:none;align-items:center;justify-content:center;padding:14px;z-index:50}
    .modal{width:min(560px,100%);background:var(--panel);border:1px solid var(--line);border-radius:18px;box-shadow:var(--shadow);overflow:hidden}
    .modalHeader{padding:12px 14px;border-bottom:1px solid var(--line);display:flex;justify-content:space-between;align-items:center}
    .modalHeader b{font-size:15px}
    .modalBody{padding:14px}
    .notice{padding:10px 12px;border-radius:12px;background:#0a0a0a;border:1px solid #202020;color:var(--muted);font-size:13px}
    .err{border-color:rgba(255,77,79,.35);color:#ffd1d1;background:rgba(255,77,79,.06)}
    .okbox{border-color:rgba(33,197,93,.35);color:#d7ffe7;background:rgba(33,197,93,.06)}
    .hide{display:none !important;}

    /* mobile */
    @media (max-width: 980px){
      .wrap{grid-template-columns: 82px 1fr; }
      .right{display:none;}
      .navText{display:none;}
      .brand b{display:none;}
      .nav a,.nav button{justify-content:center;}
    }
    @media (max-width: 640px){
      .wrap{grid-template-columns: 1fr; padding:10px}
      .left{display:none;}
      .right{display:none;}
      .card{border-radius:14px}
    }
  </style>
</head>

<body>
<div class="app">
  <div class="wrap">

    <!-- LEFT NAV -->
    <div class="left">
      <div class="card nav">
        <div class="brand">
          <div class="logo"></div>
          <b>FEEx</b>
        </div>
        <button onclick="go('feed')"><span>ğŸ </span><span class="navText">é¦–é </span></button>
        <button onclick="go('predict')"><span>ğŸ”®</span><span class="navText">æœªä¾†äº‹ä»¶é æ¸¬</span></button>
        <button onclick="go('publish')"><span>ğŸª™</span><span class="navText">çœ‹å»£å‘Šæ‹¿é‡‘å¹£</span></button>
        <button onclick="go('profile')"><span>ğŸ‘¤</span><span class="navText">å€‹äººæª”æ¡ˆ</span></button>
        <button onclick="go('rules')"><span>ğŸ“œ</span><span class="navText">è¦å‰‡ & è¨­å®š</span></button>
        <div class="sep"></div>
        <button class="btn primary" onclick="openAuth()">ç™»å…¥ / è¨»å†Š</button>
        <button class="btn ghost" onclick="logout()">ç™»å‡º</button>
        <div class="sep"></div>
        <div class="pill">API: <span id="apiBase"></span></div>
        <div class="pill">ç‹€æ…‹: <span id="statusText" class="muted">æœªç™»å…¥</span></div>
      </div>
    </div>

    <!-- MIDDLE -->
    <div class="mid">
      <div class="card">
        <div class="midHeader">
          <h1 id="pageTitle">é¦–é </h1>
          <div class="row">
            <button class="btn small" onclick="refresh()">åˆ·æ–°</button>
          </div>
        </div>

        <!-- FEED TOOLBAR -->
        <div id="feedToolbar" style="padding:12px 14px;border-bottom:1px solid var(--line)">
          <div class="row" style="justify-content:space-between;gap:10px;flex-wrap:wrap">
            <div class="subtabs">
              <button class="tab active" data-hot="day" onclick="setHot('day', this)">ç•¶æ—¥ç†±é–€</button>
              <button class="tab" data-hot="week" onclick="setHot('week', this)">æœ¬é€±ç†±é–€</button>
              <button class="tab" data-hot="month" onclick="setHot('month', this)">æœ¬æœˆç†±é–€</button>
              <button class="tab" data-hot="all" onclick="setHot('all', this)">ç¸½ç†±é–€</button>
            </div>
            <div class="row" style="gap:8px;min-width:min(460px,100%)">
              <input id="q" class="input" placeholder="æœå°‹é¡Œç›®..." onkeydown="if(event.key==='Enter'){refresh();}" />
              <button class="btn" onclick="refresh()">æœå°‹</button>
            </div>
          </div>
        </div>

        <!-- PAGES -->
        <div id="page_feed" class="feed"></div>

        <div id="page_predict" class="feed hide" style="padding:14px">
          <div class="notice">é€™è£¡å±•ç¤ºã€Œé æ¸¬åˆ—è¡¨ã€èˆ‡é»é€²è©³æƒ…ï¼ˆå·²ç”±é¦–é  feed é€£éå»ï¼‰ã€‚ç›®å‰ demo å…ˆç”¨é¦–é ã€‚</div>
        </div>

        <div id="page_publish" class="feed hide" style="padding:14px">
          <div class="col">
            <div class="notice">æŒ‰ä¸‹æŒ‰éˆ•æ¨¡æ“¬ã€Œçœ‹å»£å‘Šé ˜ 100 GCã€ã€‚å¾Œç«¯æœ‰ 12 å°æ™‚å†·å»ï¼ˆ/api/claim-adï¼‰ã€‚</div>
            <button class="btn primary" onclick="claimAd()">çœ‹å»£å‘Šæ‹¿é‡‘å¹£ï¼ˆ+100 GCï¼‰</button>
            <div id="claimMsg" class="notice hide"></div>
          </div>
        </div>

        <div id="page_profile" class="feed hide" style="padding:14px">
          <div class="col">
            <div class="notice">å€‹äººæª”æ¡ˆï¼ˆæš±ç¨±/ç°½å/å‹ç‡/ç­‰ç´š/GC/æœƒå“¡ç­‰ç´šï¼‰ã€‚ä¿®æ”¹æœƒæ‰“ /api/me PATCHã€‚</div>
            <div class="row" style="gap:12px;flex-wrap:wrap">
              <div style="flex:1;min-width:240px">
                <div class="muted" style="margin-bottom:6px">æš±ç¨±ï¼ˆ20å­—å…§ï¼‰</div>
                <input id="meNick" class="input" placeholder="Nick" />
              </div>
              <div style="flex:1;min-width:240px">
                <div class="muted" style="margin-bottom:6px">å€‹äººç°½åï¼ˆ140å­—å…§ï¼‰</div>
                <input id="meBio" class="input" placeholder="Bio" />
              </div>
            </div>

            <div class="row" style="gap:12px;flex-wrap:wrap">
              <div style="flex:1;min-width:160px">
                <div class="muted" style="margin-bottom:6px">æœƒå“¡ç­‰ç´š Tier</div>
                <input id="meTier" class="input" type="number" min="1" max="10" />
              </div>
              <div style="flex:1;min-width:160px">
                <div class="muted" style="margin-bottom:6px">ç­‰ç´š Level</div>
                <input id="meLevel" class="input" type="number" min="1" max="999" />
              </div>
              <div style="flex:1;min-width:160px">
                <div class="muted" style="margin-bottom:6px">é æ¸¬å‹ç‡ %</div>
                <input id="meWin" class="input" type="number" min="0" max="100" />
              </div>
              <div style="flex:1;min-width:160px">
                <div class="muted" style="margin-bottom:6px">é‡‘å¹£ GC</div>
                <input id="meGC" class="input" type="number" disabled />
              </div>
            </div>

            <div class="row" style="gap:10px;flex-wrap:wrap">
              <button class="btn primary" onclick="saveMe()">å„²å­˜</button>
              <button class="btn" onclick="loadMe()">é‡æ–°è¼‰å…¥</button>
              <span id="meMsg" class="notice hide"></span>
            </div>
          </div>
        </div>

        <div id="page_rules" class="feed hide" style="padding:14px">
          <div class="col">
            <div class="notice">
              <b>è¦å‰‡ & è¨­å®šï¼ˆçµ¦ä½¿ç”¨è€…çœ‹çš„ï¼‰</b><br><br>
              â€¢ GC æ˜¯å¹³å°å…§é»æ•¸ï¼Œä¸å¯å…Œæ›å›ä»»ä½•æ³•å¹£/ä»£å¹£ã€‚<br>
              â€¢ é æ¸¬åƒ…ä¾›å¨›æ¨‚èˆ‡ç¤¾ç¾¤äº’å‹•ï¼Œçµæœå¯èƒ½ä¸æº–ç¢ºã€‚<br>
              â€¢ åƒèˆ‡å‰è«‹è‡ªè¡Œè©•ä¼°é¢¨éšªï¼Œå‹¿æŠ•å…¥è¶…å‡ºæ‰¿å—ç¯„åœçš„ GCã€‚<br>
              â€¢ å¹³å°å¯èƒ½èª¿æ•´è¦å‰‡/åƒæ•¸ä»¥ç¶­è­·å…¬å¹³æ€§èˆ‡å®‰å…¨æ€§ã€‚<br>
            </div>
            <div class="row">
              <span class="pill">é¡¯ç¤ºè¨­å®š</span>
              <button class="btn" onclick="toggleTheme()">é–‹ç‡ˆ / é—œç‡ˆ</button>
              <button class="btn" onclick="fontSize(1)">å­—é«”+</button>
              <button class="btn" onclick="fontSize(-1)">å­—é«”-</button>
            </div>
          </div>
        </div>

      </div>
    </div>

    <!-- RIGHT: TAGS -->
    <div class="right">
      <div class="card rightBox">
        <h3>åˆ†é¡ TAG</h3>
        <div class="tagGrid" id="tagGrid"></div>
        <div class="sep"></div>
        <div class="notice">
          å°æé†’ï¼šç†±é–€æ’åºæ˜¯å¾Œç«¯ä¾ hot=day/week/month/all è¨ˆç®—ã€‚<br>
          é»é¡Œç›®å¯é€²å…¥è©³æƒ…é ï¼ˆdemo å…ˆç”¨å½ˆçª—é¡¯ç¤ºï¼‰ã€‚
        </div>
      </div>
    </div>

  </div>
</div>

<!-- AUTH MODAL -->
<div id="authBackdrop" class="modalBackdrop">
  <div class="modal">
    <div class="modalHeader">
      <b>ç™»å…¥ / è¨»å†Š</b>
      <button class="btn small" onclick="closeAuth()">âœ•</button>
    </div>
    <div class="modalBody">
      <div id="authMsg" class="notice hide"></div>

      <div class="col">
        <div>
          <div class="muted" style="margin-bottom:6px">Email</div>
          <input id="email" class="input" placeholder="you@example.com" autocomplete="email" />
        </div>
        <div>
          <div class="muted" style="margin-bottom:6px">Password</div>
          <input id="password" class="input" type="password" placeholder="è‡³å°‘ 6 ç¢¼" autocomplete="current-password" />
        </div>

        <div class="row" style="gap:10px;flex-wrap:wrap">
          <button class="btn primary" onclick="doLogin()">ç™»å…¥</button>
          <button class="btn" onclick="doRegister()">è¨»å†Š</button>
          <button class="btn ghost" onclick="closeAuth()">å–æ¶ˆ</button>
        </div>

        <div class="sep"></div>

        <div class="notice">
          <b>Google ç™»å…¥</b><br>
          ä½ å¾Œç«¯è‹¥å·²å®Œæˆ Google OAuth è·¯ç”±ï¼ˆä¾‹å¦‚ /api/auth/google/start /callbackï¼‰ï¼ŒæŠŠä¸‹é¢æŒ‰éˆ•çš„é€£çµæ”¹æˆä½ çš„è·¯ç”±å³å¯ã€‚
          å¦‚æœä½ å¾Œç«¯ç›®å‰é‚„æ²’æœ‰ Google OAuth è·¯ç”±ï¼Œå…ˆä¸è¦æŒ‰ä¹Ÿæ²’é—œä¿‚ã€‚
        </div>
        <button class="btn" onclick="googleStart()">ä½¿ç”¨ Google ç™»å…¥</button>
      </div>
    </div>
  </div>
</div>

<!-- DETAIL MODAL -->
<div id="detailBackdrop" class="modalBackdrop">
  <div class="modal">
    <div class="modalHeader">
      <b id="detailTitle">é¡Œç›®</b>
      <button class="btn small" onclick="closeDetail()">âœ•</button>
    </div>
    <div class="modalBody" id="detailBody"></div>
  </div>
</div>

<script>
  // ====== CONFIG ======
  const API_BASE = "https://api.feex.win"; // â† ç¢ºèªé€™æ˜¯ä½ çš„ Worker è‡ªè¨‚ç¶²åŸŸ
  document.getElementById("apiBase").textContent = API_BASE.replace("https://","");

  // TAGS
  const TAGS = ["all","sport","news","politics","tech","finance","ent","games"];
  const TAG_LABEL = {all:"å…¨éƒ¨", sport:"é‹å‹•", news:"æ™‚å‹¢", politics:"æ”¿æ²»", tech:"ç§‘æŠ€", finance:"é‡‘è", ent:"å¨›æ¨‚", games:"éŠæˆ²"};

  // ====== STATE ======
  let state = {
    page: "feed",
    tag: "all",
    hot: "day",
    q: "",
    token: localStorage.getItem("token") || "",
    me: null,
  };

  // ====== HELPERS ======
  const $ = (id)=>document.getElementById(id);
  function show(el){ el.classList.remove("hide"); }
  function hide(el){ el.classList.add("hide"); }
  function setMsg(el, text, kind="info"){
    el.textContent = text;
    el.className = "notice" + (kind==="err" ? " err" : kind==="ok" ? " okbox" : "");
    show(el);
  }
  function clearMsg(el){ hide(el); el.textContent=""; }

  async function api(path, opts={}){
    const headers = Object.assign({"Content-Type":"application/json"}, opts.headers||{});
    if(state.token) headers["Authorization"] = "Bearer " + state.token;
    const res = await fetch(API_BASE + path, Object.assign({}, opts, {headers}));
    const data = await res.json().catch(()=>({ok:false,error:"Bad JSON"}));
    return {res, data};
  }

  function fmtTime(ms){
    try { return new Date(Number(ms)).toLocaleString(); } catch { return ""; }
  }

  // ====== NAV ======
  function go(page){
    state.page = page;
    ["feed","predict","publish","profile","rules"].forEach(p=>{
      const el = $("page_"+p);
      if(!el) return;
      if(p===page) el.classList.remove("hide");
      else el.classList.add("hide");
    });
    $("feedToolbar").style.display = page==="feed" ? "block" : "none";
    $("pageTitle").textContent =
      page==="feed" ? "é¦–é " :
      page==="predict" ? "æœªä¾†äº‹ä»¶é æ¸¬" :
      page==="publish" ? "çœ‹å»£å‘Šæ‹¿é‡‘å¹£" :
      page==="profile" ? "å€‹äººæª”æ¡ˆ" : "è¦å‰‡ & è¨­å®š";

    if(page==="profile") loadMe();
    if(page==="feed") refresh();
  }

  // ====== AUTH MODAL ======
  function openAuth(){ $("authBackdrop").style.display="flex"; clearMsg($("authMsg")); }
  function closeAuth(){ $("authBackdrop").style.display="none"; }
  function closeDetail(){ $("detailBackdrop").style.display="none"; }

  async function doRegister(){
    clearMsg($("authMsg"));
    const email = $("email").value.trim();
    const password = $("password").value;
    if(!email || !email.includes("@")) return setMsg($("authMsg"), "Email æ ¼å¼ä¸æ­£ç¢º", "err");
    if((password||"").length < 6) return setMsg($("authMsg"), "å¯†ç¢¼è‡³å°‘ 6 ç¢¼", "err");

    const {data} = await api("/api/register", {method:"POST", body: JSON.stringify({email,password})});
    if(!data.ok) return setMsg($("authMsg"), data.error || "è¨»å†Šå¤±æ•—", "err");
    setMsg($("authMsg"), "è¨»å†ŠæˆåŠŸï¼Œè«‹ç™»å…¥", "ok");
  }

  async function doLogin(){
    clearMsg($("authMsg"));
    const email = $("email").value.trim();
    const password = $("password").value;
    if(!email || !password) return setMsg($("authMsg"), "è«‹è¼¸å…¥ Email èˆ‡å¯†ç¢¼", "err");

    const {data} = await api("/api/login", {method:"POST", body: JSON.stringify({email,password})});
    if(!data.ok) return setMsg($("authMsg"), data.error || "ç™»å…¥å¤±æ•—", "err");

    state.token = data.token;
    localStorage.setItem("token", state.token);
    await loadMe();
    setStatus();
    setMsg($("authMsg"), "ç™»å…¥æˆåŠŸï¼", "ok");
    setTimeout(()=>closeAuth(), 600);
  }

  function logout(){
    state.token = "";
    state.me = null;
    localStorage.removeItem("token");
    setStatus();
    alert("å·²ç™»å‡º");
  }

  // Google OAuth start (ä½ å¾Œç«¯è‹¥æœ‰è·¯ç”±å°±æ”¹é€™è£¡)
  function googleStart(){
    // ä¾‹ï¼šwindow.location.href = API_BASE + "/api/auth/google/start";
    alert("å¦‚æœä½ å¾Œç«¯å·²åš Google OAuthï¼Œè«‹æŠŠ googleStart() æ”¹æˆå°å‘ä½ çš„ /api/auth/google/start");
  }

  // ====== ME ======
  function setStatus(){
    const t = state.me ? `å·²ç™»å…¥ï¼š${state.me.nick}ï¼ˆTier ${state.me.tier} / GC ${state.me.gc}ï¼‰` : "æœªç™»å…¥";
    $("statusText").textContent = t;
    $("statusText").className = state.me ? "ok" : "muted";
  }

  async function loadMe(){
    if(!state.token) { state.me=null; setStatus(); return; }
    const {data} = await api("/api/me", {method:"GET"});
    if(!data.ok){
      // token å¤±æ•ˆ
      state.token=""; localStorage.removeItem("token");
      state.me=null; setStatus();
      return;
    }
    state.me = data.user;
    setStatus();
    // fill profile
    $("meNick").value = state.me.nick || "";
    $("meBio").value = state.me.bio || "";
    $("meTier").value = state.me.tier || 1;
    $("meLevel").value = state.me.level || 1;
    $("meWin").value = state.me.winRate ?? 50;
    $("meGC").value = state.me.gc ?? 0;
  }

  async function saveMe(){
    if(!state.token) return alert("è«‹å…ˆç™»å…¥");
    clearMsg($("meMsg"));
    const body = {
      nick: $("meNick").value.trim(),
      bio: $("meBio").value.trim(),
      tier: Number($("meTier").value||1),
      level: Number($("meLevel").value||1),
      winRate: Number($("meWin").value||50),
    };
    const {data} = await api("/api/me", {method:"PATCH", body: JSON.stringify(body)});
    if(!data.ok) return setMsg($("meMsg"), data.error || "å„²å­˜å¤±æ•—", "err");
    state.me = data.user;
    $("meGC").value = state.me.gc ?? 0;
    setStatus();
    setMsg($("meMsg"), "å·²å„²å­˜", "ok");
  }

  // ====== CLAIM AD ======
  async function claimAd(){
    $("claimMsg").classList.add("hide");
    if(!state.token) return alert("è«‹å…ˆç™»å…¥");
    const {data} = await api("/api/claim-ad", {method:"POST", body: "{}"});
    if(!data.ok){
      if(data.error==="Cooldown"){
        const m = Math.ceil((data.remainingMs||0)/60000);
        return setMsg($("claimMsg"), `å†·å»ä¸­ï¼Œç´„ ${m} åˆ†é˜å¾Œå¯å†é ˜`, "err");
      }
      return setMsg($("claimMsg"), data.error || "é ˜å–å¤±æ•—", "err");
    }
    await loadMe();
    setMsg($("claimMsg"), `æˆåŠŸ +${data.reward} GCï¼Œç›®å‰é¤˜é¡ï¼š${data.newBalance}`, "ok");
  }

  // ====== FEED ======
  function setHot(hot, btn){
    state.hot = hot;
    document.querySelectorAll("[data-hot]").forEach(x=>x.classList.remove("active"));
    btn.classList.add("active");
    refresh();
  }

  function renderTags(){
    const grid = $("tagGrid");
    grid.innerHTML = "";
    TAGS.forEach(t=>{
      const b = document.createElement("button");
      b.className = "tag" + (state.tag===t ? " active":"");
      b.textContent = TAG_LABEL[t] || t;
      b.onclick = ()=>{ state.tag=t; renderTags(); refresh(); };
      grid.appendChild(b);
    });
  }

  function ellipsize(text, n=120){
    text = String(text||"");
    if(text.length<=n) return {short:text, cut:false};
    return {short:text.slice(0,n)+"â€¦", cut:true};
  }

  function postEl(p){
    const div = document.createElement("div");
    div.className = "post";

    const av = document.createElement("div");
    av.className = "avatar";

    const main = document.createElement("div");

    const top = document.createElement("div");
    top.className = "postTop";
    top.innerHTML = `
      <div>
        <span class="nick">@${(p.ownerNick || "unknown")}</span>
        <span class="meta"> Â· ${TAG_LABEL[p.tag]||p.tag} Â· ${p.settleDate}</span>
      </div>
      <span class="meta">${fmtTime(p.createdAt)}</span>
    `;

    const title = document.createElement("div");
    title.className = "title";
    title.textContent = p.title;

    const cover = document.createElement("div");
    cover.className = "cover";
    if(p.coverUrl){
      const img = document.createElement("img");
      img.src = p.coverUrl;
      img.alt = "cover";
      cover.appendChild(img);
    }else{
      cover.innerHTML = `<span class="muted">ï¼ˆç„¡å°é¢ï¼‰</span>`;
    }

    const tc = document.createElement("div");
    tc.style.marginTop = "10px";
    tc.innerHTML = (p.topComments||[]).map((c,idx)=>{
      const {short,cut} = ellipsize(c.text, 90);
      const id = `c_${p.id}_${idx}`;
      return `
        <div class="meta" style="margin:6px 0 0">
          â¤ï¸ ${c.likes} Â· <b>@${c.author}</b>ï¼š
          <span id="${id}" class="${cut?'twolines':''}">${short}</span>
          ${cut ? `<span class="more" onclick="expand('${id}', ${JSON.stringify(c.text).replace(/"/g,'&quot;')})">é¡¯ç¤ºæ›´å¤š</span>` : ""}
        </div>
      `;
    }).join("");

    const actions = document.createElement("div");
    actions.className = "actions";
    actions.innerHTML = `
      <button class="actionBtn" title="è©³ç´°" onclick="openDetail('${p.id}')">ğŸ’¬ ${p.commentsCount||0}</button>
      <span>â¤ï¸ ${p.likes||0}</span>
      <span>ğŸ—³ï¸ ${p.totalVotes||0}</span>
      <button class="actionBtn" onclick="openDetail('${p.id}')">æŸ¥çœ‹å®Œæ•´</button>
    `;

    main.appendChild(top);
    main.appendChild(title);
    main.appendChild(cover);
    main.appendChild(tc);
    main.appendChild(actions);

    div.appendChild(av);
    div.appendChild(main);
    return div;
  }

  // ç”¨æ–¼ã€Œé¡¯ç¤ºæ›´å¤šã€
  window.expand = (id, fullText)=>{
    const el = document.getElementById(id);
    if(!el) return;
    el.classList.remove("twolines");
    el.textContent = fullText;
    // ç§»é™¤æ—é‚Šçš„ã€Œé¡¯ç¤ºæ›´å¤šã€
    const sib = el.nextElementSibling;
    if(sib && sib.classList.contains("more")) sib.remove();
  };

  async function refresh(){
    if(state.page!=="feed") return;
    state.q = $("q").value.trim();

    const params = new URLSearchParams();
    params.set("tag", state.tag);
    params.set("hot", state.hot);
    if(state.q) params.set("q", state.q);

    const feed = $("page_feed");
    feed.innerHTML = `<div style="padding:14px" class="muted">è¼‰å…¥ä¸­...</div>`;

    const {data} = await api("/api/predictions?"+params.toString(), {method:"GET"});
    if(!data.ok){
      feed.innerHTML = `<div style="padding:14px" class="danger">è¼‰å…¥å¤±æ•—ï¼š${data.error||"error"}</div>`;
      return;
    }

    // âš ï¸ éœ€è¦å¾Œç«¯å› ownerNickã€‚è‹¥ä½ å¾Œç«¯å°šæœªåšï¼Œæˆ‘ä¸‹é¢æœƒèªªè¦æ”¹å“ªè£¡ã€‚
    feed.innerHTML = "";
    (data.predictions||[]).forEach(p=> feed.appendChild(postEl(p)));
    if((data.predictions||[]).length===0){
      feed.innerHTML = `<div style="padding:14px" class="muted">ç›®å‰æ²’æœ‰å…§å®¹</div>`;
    }
  }

  // ====== DETAIL ======
  async function openDetail(predId){
    $("detailBackdrop").style.display = "flex";
    $("detailTitle").textContent = "è¼‰å…¥ä¸­...";
    $("detailBody").innerHTML = `<div class="muted">loading...</div>`;

    const {data} = await api("/api/predictions/"+predId, {method:"GET"});
    if(!data.ok){
      $("detailTitle").textContent = "éŒ¯èª¤";
      $("detailBody").innerHTML = `<div class="danger">${data.error||"error"}</div>`;
      return;
    }
    const p = data.prediction;
    $("detailTitle").textContent = p.title;

    const cover = p.coverUrl ? `<div class="cover" style="margin:10px 0"><img src="${p.coverUrl}" /></div>` : "";
    const opts = (p.options||[]).map(o=>{
      const my = p.myVote===o.id ? " (å·²æŠ•)" : "";
      return `<button class="btn" style="width:100%;text-align:left" onclick="doVote('${predId}','${o.id}')">ğŸ—³ï¸ ${o.text} Â· ${o.votes}${my}</button>`;
    }).join("");

    const comments = (p.comments||[]).slice(0,200).map(c=>{
      return `
        <div style="padding:10px 0;border-top:1px solid var(--line)">
          <div class="row" style="justify-content:space-between">
            <div><b>@${c.author}</b> <span class="meta">Â· ${fmtTime(c.createdAt)}</span></div>
            <button class="btn small" onclick="likeComment('${c.id}')">â¤ï¸ ${c.likes}</button>
          </div>
          <div style="margin-top:6px;white-space:pre-wrap">${escapeHtml(c.text)}</div>
        </div>
      `;
    }).join("");

    $("detailBody").innerHTML = `
      <div class="pill">${TAG_LABEL[p.tag]||p.tag} Â· çµç®—æ—¥ ${p.settleDate}</div>
      ${cover}
      <div class="row" style="gap:10px;flex-wrap:wrap;margin:10px 0">
        <button class="btn" onclick="likePred('${predId}')">â¤ï¸ ${p.likes} ${p.likedByMe ? "(å·²è®š)" : ""}</button>
        <span class="pill">ç•™è¨€ ${p.commentsCount}</span>
        <span class="pill">ç¸½ç¥¨æ•¸ ${p.totalVotes}</span>
      </div>

      <div class="col" style="gap:8px">
        ${opts}
      </div>

      <div class="sep"></div>

      <div class="col">
        <textarea id="cText" class="input" rows="3" placeholder="ç•™è¨€ï¼ˆ300å­—å…§ï¼‰"></textarea>
        <button class="btn primary" onclick="postComment('${predId}')">é€å‡ºç•™è¨€</button>
      </div>

      <div class="sep"></div>
      <div><b>ç•™è¨€</b></div>
      <div>${comments || `<div class="muted" style="padding:8px 0">æš«ç„¡ç•™è¨€</div>`}</div>
    `;
  }

  async function doVote(predId, optionId){
    if(!state.token) return openAuth();
    const {data} = await api(`/api/predictions/${predId}/vote`, {method:"POST", body: JSON.stringify({optionId})});
    if(!data.ok) return alert(data.error || "æŠ•ç¥¨å¤±æ•—");
    await openDetail(predId);
    await refresh();
  }
  async function likePred(predId){
    if(!state.token) return openAuth();
    const {data} = await api(`/api/predictions/${predId}/like`, {method:"POST", body:"{}"});
    if(!data.ok) return alert(data.error || "æŒ‰è®šå¤±æ•—");
    await openDetail(predId);
    await refresh();
  }
  async function postComment(predId){
    if(!state.token) return openAuth();
    const text = $("cText").value.trim();
    if(!text) return alert("è«‹è¼¸å…¥ç•™è¨€");
    const {data} = await api(`/api/predictions/${predId}/comments`, {method:"POST", body: JSON.stringify({text})});
    if(!data.ok) return alert(data.error || "é€å‡ºå¤±æ•—");
    $("cText").value = "";
    await openDetail(predId);
    await refresh();
  }
  async function likeComment(commentId){
    if(!state.token) return openAuth();
    const {data} = await api(`/api/comments/${commentId}/like`, {method:"POST", body:"{}"});
    if(!data.ok) return alert(data.error || "æŒ‰è®šå¤±æ•—");
    // é‡æ–°é–‹ detail æœƒé‡åˆ· likes
    // å–ç›®å‰ modal title è£¡çš„ pred id æ¯”è¼ƒéº»ç…©ï¼Œç›´æ¥æç¤ºä½¿ç”¨è€…åˆ·æ–°å³å¯ï¼ˆæˆ–ä½ å¯è‡ªè¡Œåš state.detailPredIdï¼‰
    alert("å·²æ›´æ–°ï¼Œè«‹é—œé–‰å†é‡é–‹è©³æƒ…æˆ–åˆ·æ–°é é¢");
    await refresh();
  }

  function escapeHtml(s){
    return String(s||"").replace(/[&<>"']/g, (c)=>({
      "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;"
    }[c]));
  }

  // ====== SETTINGS ======
  function toggleTheme(){
    // ç°¡æ˜“ï¼šé»‘/æ›´é»‘ï¼ˆdemoï¼‰
    const r = document.documentElement.style;
    const bg = getComputedStyle(document.documentElement).getPropertyValue("--bg").trim();
    if(bg==="#000"){
      r.setProperty("--bg", "#f6f6f6");
      r.setProperty("--panel", "#ffffff");
      r.setProperty("--panel2", "#f3f4f6");
      r.setProperty("--text", "#111");
      r.setProperty("--muted", "#555");
      r.setProperty("--line", "#e5e7eb");
      r.setProperty("--chip", "#eef2f7");
    }else{
      r.setProperty("--bg", "#000");
      r.setProperty("--panel", "#0b0b0b");
      r.setProperty("--panel2", "#111");
      r.setProperty("--text", "#e7e7e7");
      r.setProperty("--muted", "#9aa0a6");
      r.setProperty("--line", "#222");
      r.setProperty("--chip", "#16181c");
    }
  }
  function fontSize(delta){
    const cur = parseFloat(getComputedStyle(document.body).fontSize);
    const next = Math.max(12, Math.min(20, cur + delta));
    document.body.style.fontSize = next + "px";
  }

  // ====== INIT ======
  renderTags();
  go("feed");
  loadMe();
  setStatus();
</script>
</body>
</html>
